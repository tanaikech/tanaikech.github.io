<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.24.1" />

  <title>Downloading Files From Google Drive Under No Authorization Using Browser &middot; tanaike</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://plus.google.com/+KanshiTanaike" target="_blank"><i class="fa fa-google-plus-square fa-fw"></i>Google+</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" target="_blank"><i class="fa fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Downloading Files From Google Drive Under No Authorization Using Browser</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>04 Jul 2017, 15:57</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/download">download</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/webapps">webapps</a>
    
  </div>
  
  

</div>

  

<p><a name="TOP"></a></p>

<p><a href="https://gist.github.com/tanaikech/c5b2811bce01cbcc26ffa357df496379">Gist</a></p>

<p>This is a sample script for downloading files from Google Drive under no authorization using browser. By using this sample, you can make other users download files from your Google Drive. Even if the other users are not Google users, they can download the files.</p>

<p><a name="demo"></a></p>

<h2 id="demo">Demo</h2>

<p><img src="https://tanaikech.github.io/img/20170704-demo_simple.gif" alt="" /></p>

<p>This is a demonstration for downloading files from Google Drive under no authorization using browser. From the top document, You can see that an user who is not owner of Google Drive is downloading files.</p>

<h2 id="problems-and-workaround">Problems and Workaround</h2>

<p>In order to download files from Google Drive under no authorization, there are some problems. When files are downloaded from Google Drive, it is necessary to use Download Link and Drive API.</p>

<ol>
<li>In the case of use the Download Link for each file, only owner of Google Drive can download the files, even if the permission of files are changed as the ANYONE.</li>
<li>In the case of use the Drive API, users have to authorize at Google using OAuth2 process.</li>
</ol>

<p>I have already known that files can download under no authorization using <a href="https://tanaikech.github.io/2017/03/20/download-files-without-authorization-from-google-drive/">base64</a> and <a href="https://tanaikech.github.io/2017/05/10/file-transfer-for-google-drive-without-authorization/">byte array</a>. For these problems, I solved this using base64.</p>

<h2 id="sample-script">Sample Script</h2>

<p>In order to use this sample script, it is necessary to deploy Web Apps. The how to deploy Web Apps is as follows.</p>

<ul>
<li>On the Script Editor

<ul>
<li>File</li>
<li>-&gt; Manage Versions</li>
<li>-&gt; Save New Version</li>
<li>Publish</li>
<li>-&gt; Deploy as Web App</li>
<li>-&gt; At Execute the app as, select <strong>&ldquo;your account&rdquo;</strong></li>
<li>-&gt; At Who has access to the app, select <strong>&ldquo;Anyone, even anonymous&rdquo;</strong></li>
<li>-&gt; Click &ldquo;Deploy&rdquo;</li>
<li>-&gt; Copy <strong>&ldquo;Current web app URL&rdquo;</strong></li>
<li>-&gt; Click &ldquo;OK&rdquo;</li>
</ul></li>
</ul>

<p>And then, please copy and paste following respective HTML and GAS to your script editor. You can use the sample for the script of both container-bound script and standalone script. Following image is the project pasted the sample script. You can see the 2 files in the project.</p>

<p><img src="https://tanaikech.github.io/img/20170704-project.png" alt="" /></p>

<h3 id="script">Script</h3>

<h4 id="html">HTML</h4>

<p>Filename is <code>index.html</code>.</p>

<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;
    &lt;script src=&quot;https://code.jquery.com/jquery-3.2.1.min.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div class=&quot;files&quot;&gt;
        &lt;form&gt;
            &lt;table class=&quot;table table-striped table-hover&quot;&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;Download&lt;/th&gt;
                        &lt;th&gt;FileName&lt;/th&gt;
                        &lt;th&gt;Size[byte]&lt;/th&gt;
                        &lt;th&gt;Parents&lt;/th&gt;
                        &lt;th&gt;Updated&lt;/th&gt;
                        &lt;th&gt;Created&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    &lt;? for (var i = 0; i &lt; data.length; i++) { ?&gt;
                        &lt;tr&gt;
                            &lt;td&gt;
                                &lt;input type=&quot;checkbox&quot; id=&quot;checkbox&quot; name=&quot;fileId&quot; value=&quot;&lt;?= data[i].file_id  ?&gt;&quot; /&gt;
                            &lt;/td&gt;
                            &lt;td&gt;
                                &lt;?= data[i].file_name ?&gt;
                            &lt;/td&gt;
                            &lt;td&gt;
                                &lt;?= data[i].file_size ?&gt;
                            &lt;/td&gt;
                            &lt;td&gt;
                                &lt;?= data[i].folder_tree ?&gt;
                            &lt;/td&gt;
                            &lt;td&gt;
                                &lt;?= data[i].file_updated ?&gt;
                            &lt;/td&gt;
                            &lt;td&gt;
                                &lt;?= data[i].file_created ?&gt;
                            &lt;/td&gt;
                        &lt;/tr&gt;
                        &lt;? } ?&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
            &lt;div class=&quot;allchk&quot;&gt;
                &lt;input type=&quot;checkbox&quot; id=&quot;allCheck01&quot;&gt;
                &lt;label for=&quot;allCheck01&quot;&gt;Check All&lt;/label&gt;
            &lt;/div&gt;
            &lt;input type=&quot;button&quot; class=&quot;create&quot; value=&quot;Download&quot; onclick=&quot;google.script.run.withSuccessHandler(executeDownload).getparams(this.parentNode)&quot;&gt;
        &lt;/form&gt;
    &lt;/div&gt;
    &lt;a id=&quot;dl&quot; target=&quot;_blank&quot; href=&quot;#&quot;&gt;&lt;/a&gt;
&lt;/body&gt;

&lt;script&gt;
$(function() {
    $('.table tr').click(function(event) {
        if (event.target.type !== 'checkbox') {
            $(':checkbox', this).trigger('click');
        }
    });

    $('.allchk input').click(function() {
        var files = $('.files').find('input');
        if ($(this).is(':checked')) {
            $(files).prop('checked', true);
        } else {
            $(files).prop('checked', false);
        }
    });
});

function executeDownload(base64dat) {
    $(&quot;#dl&quot;).prop(&quot;href&quot;, window.URL.createObjectURL(toBlob(base64dat))).prop(&quot;download&quot;, &quot;dl_&quot; + getfmtDate() + &quot;.zip&quot;)[0].click();
}

function toBlob(base64) {
    var bin = atob(base64.replace(/^.*,/, ''));
    var buffer = new Uint8Array(bin.length);
    for (var i = 0; i &lt; bin.length; i++) {
        buffer[i] = bin.charCodeAt(i);
    }
    try {
        var blob = new Blob([buffer.buffer], {
            type: 'application/zip'
        });
    } catch (e) {
        return false;
    }
    return blob;
}

function getfmtDate() {
    var dt = new Date();
    return dt.getFullYear().toString() +
        cd((dt.getMonth() + 1).toString()) +
        cd(dt.getDate().toString()) +
        &quot;_&quot; +
        cd(dt.getHours().toString()) +
        cd(dt.getMinutes().toString()) +
        cd(dt.getSeconds().toString());
};

function cd(dat) {
    return dat.length == 1 ? &quot;0&quot; + dat : dat;
};
&lt;/script&gt;

&lt;/html&gt;
</code></pre>

<h4 id="google-apps-script">Google Apps Script</h4>

<p>Filename is <code>code.gs</code>.</p>

<pre><code class="language-javascript">var folderId = &quot;### Folder ID ###&quot;; // &lt;--- Your shared folder ID

function doGet() {
    var t = HtmlService.createTemplateFromFile('index');
    t.data = getFileList();
    return t.evaluate();
}

function getparams(e) {
    return zipping(typeof(e.fileId) == &quot;string&quot; ? [e.fileId] : e.fileId);
}

function getFileList() {
    var folderlist = (function(folder, folderSt, results) {
        var ar = [];
        var folders = folder.getFolders();
        while (folders.hasNext()) ar.push(folders.next());
        folderSt += folder.getId() + &quot;#_aabbccddee_#&quot;;
        var array_folderSt = folderSt.split(&quot;#_aabbccddee_#&quot;);
        array_folderSt.pop()
        results.push(array_folderSt);
        ar.length == 0 &amp;&amp; (folderSt = &quot;&quot;);
        for (var i in ar) arguments.callee(ar[i], folderSt, results);
        return results;
    })(DriveApp.getFolderById(folderId), &quot;&quot;, []);
    var localTimeZone = Session.getScriptTimeZone();
    var filelist = [];
    var temp = {};
    for (var i in folderlist) {
        var folderid = folderlist[i][folderlist[i].length - 1];
        var folder = DriveApp.getFolderById(folderid);
        var files = folder.getFiles();
        while (files.hasNext()) {
            var file = files.next();
            temp = {
                folder_tree: function(folderlist, i) {
                    if (i &gt; 0) {
                        return &quot;/&quot; + [DriveApp.getFolderById(folderlist[i][j]).getName() for (j in folderlist[i])
                            if (j &gt; 0)].join(&quot;/&quot;) + &quot;/&quot;;
                    } else {
                        return &quot;/&quot;;
                    }
                }(folderlist, i),
                file_id: file.getId(),
                file_name: file.getName(),
                file_size: file.getBlob().getBytes().length,
                file_created: Utilities.formatDate(file.getDateCreated(), localTimeZone, &quot;yyyy/MM/dd HH:mm:ss&quot;),
                file_updated: Utilities.formatDate(file.getLastUpdated(), localTimeZone, &quot;yyyy/MM/dd HH:mm:ss&quot;),
            };
            filelist.push(temp);
            temp = {}
        }
    }
    var sortedlist = filelist.sort(function(e1, e2) {
        return (e1.folder_tree &gt; e2.folder_tree ? 1 : -1) });
    return sortedlist;
}

function zipping(fileId) {
    var blobs = [];
    var mimeInf = [];
    fileId.forEach(function(e) {
        try {
            var file = DriveApp.getFileById(e);
            var mime = file.getMimeType();
            var name = file.getName();
        } catch (e) {
            return e
        }
        Logger.log(mime)
        var blob;
        if (mime.indexOf('google-apps') &gt; 0) {
            mimeInf =
                mime == &quot;application/vnd.google-apps.spreadsheet&quot; ? [&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;, name + &quot;.xlsx&quot;] : mime == &quot;application/vnd.google-apps.document&quot; ? [&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;, name + &quot;.docx&quot;] : mime == &quot;application/vnd.google-apps.presentation&quot; ? [&quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot;, name + &quot;.pptx&quot;] : [&quot;application/pdf&quot;, name + &quot;.pdf&quot;];
            blob = UrlFetchApp.fetch(&quot;https://www.googleapis.com/drive/v3/files/&quot; + e + &quot;/export?mimeType=&quot; + mimeInf[0], {
                method: &quot;GET&quot;,
                headers: { &quot;Authorization&quot;: &quot;Bearer &quot; + ScriptApp.getOAuthToken() },
                muteHttpExceptions: true
            }).getBlob().setName(mimeInf[1]);
        } else {
            blob = UrlFetchApp.fetch(&quot;https://www.googleapis.com/drive/v3/files/&quot; + e + &quot;?alt=media&quot;, {
                method: &quot;GET&quot;,
                headers: { &quot;Authorization&quot;: &quot;Bearer &quot; + ScriptApp.getOAuthToken() },
                muteHttpExceptions: true
            }).getBlob().setName(name);
        }
        blobs.push(blob);
    });
    var zip = Utilities.zip(blobs, Utilities.formatDate(new Date(), Session.getScriptTimeZone(), &quot;yyyyMMdd_HHmmss&quot;) + '.zip');
    var bytedat = DriveApp.createFile(zip).getBlob().getBytes();
    return Utilities.base64Encode(bytedat);
}
</code></pre>

<h4 id="flow-of-sample-script">Flow of sample script</h4>

<ol>
<li>All files in a folder that owner of Google Drive decided display as a list using <a href="https://developers.google.com/apps-script/guides/web">Web Apps</a>.</li>
<li>Users access to the site which was used by Web Apps using own browser.</li>
<li>When users clicked the files from the list and pushed DOWNLOAD button, the files are converted to base64 using Google Apps Script.</li>
<li>The converted-base64 data are transfered to the site and are converted to blob using Javascript in HTML.</li>
<li>The blob data are compressed by ZIP, and then they are downloaded.</li>
<li>Google Spreadsheet, Google Document and Google Slide are converted to Microsoft Excel, Word and Powerpoint, respectively. Images and PDF are not converted to other format.</li>
</ol>

<h4 id="sample-folder-structure">Sample Folder Structure</h4>

<p>The folder structure as a sample is as follows. <code>sharedFolder</code> is the top directory that owner was set. All of files and directories in the directory that owner defined is displayed as a list. At the <a href="#demo">demonstration</a>, you can see it.</p>

<p><img src="https://tanaikech.github.io/img/20170704-samplestructure.png" alt="" /></p>

<h4 id="references">References</h4>

<ul>
<li><a href="https://stackoverflow.com/questions/2228382/select-all-checkboxes-with-jquery">Select all checkboxes with jQuery</a></li>
<li><a href="https://stackoverflow.com/questions/18296850/click-table-rows-to-select-checkbox-using-jquery">Click table rows to select checkbox using jQuery</a></li>
<li><a href="http://qiita.com/uin010bm/items/150003f016287750cf34">Converting from base64 to blob</a></li>
</ul>

<p><a href="#TOP">TOP</a></p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2017/06/30/updated-cli-tool---gislack/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2017/06/30/updated-cli-tool---gislack/">Updated: CLI Tool - gislack</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://tanaikech.github.io/2017/07/05/pseudo-browser-with-google-spreadsheet/">Pseudo Browser with Google Spreadsheet</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://tanaikech.github.io/2017/07/05/pseudo-browser-with-google-spreadsheet/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
    }
  });
</script>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-84325623-1', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>

