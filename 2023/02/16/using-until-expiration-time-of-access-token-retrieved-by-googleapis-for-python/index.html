<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Using Until Expiration Time of Access Token Retrieved By googleapis for Python &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Using Until Expiration Time of Access Token Retrieved By googleapis for Python</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>16 Feb 2023, 15:05</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/pythontips">PythonTips</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/python">python</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-api">google api</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/service-account">Service Account</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/b2d877e4e4d274b17876191d48204882">Gists</a></p>
<p>When Google APIs are used with <a href="https://github.com/googleapis/google-api-python-client">googleapis for Python</a>, the client is obtained as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>creds <span style="color:#f92672">=</span> service_account<span style="color:#f92672">.</span>Credentials<span style="color:#f92672">.</span>from_service_account_file(service_account_credential_file, scopes<span style="color:#f92672">=</span>scopes)
</span></span><span style="display:flex;"><span>service <span style="color:#f92672">=</span> build(<span style="color:#e6db74">&#34;drive&#34;</span>, <span style="color:#e6db74">&#34;v3&#34;</span>, credentials<span style="color:#f92672">=</span>creds)
</span></span></code></pre></div><p>In this case, when the script is run, the access token is retrieved every time. But, the expiration time of the retrieved access token is 1 hour. Here, there might be the case that you want to use the access token until the expiration time. It is considered that effectively using the access token will lead to SDGs. In this post, I would like to introduce a sample script for using the access token until the expiration time.</p>
<p>The sample script is as follows.</p>
<p><strong>If you want to use this script, first, please create a service account and retrieve the credential file of the service account.</strong></p>
<h2 id="sample-script">Sample script</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timezone
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> google.auth.transport.requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> google.oauth2 <span style="color:#f92672">import</span> service_account
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> googleapiclient.discovery <span style="color:#f92672">import</span> build
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> google.oauth2.credentials <span style="color:#f92672">import</span> Credentials
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service_account_credential_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span> <span style="color:#75715e"># Please set the credential file of your service account.</span>
</span></span><span style="display:flex;"><span>scopes <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;https://www.googleapis.com/auth/drive.metadata.readonly	&#34;</span>]
</span></span><span style="display:flex;"><span>access_token_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sample_token.txt&#34;</span> <span style="color:#75715e"># Access token is stored this file.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GetCredential</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__writeObj</span>(self):
</span></span><span style="display:flex;"><span>        creds <span style="color:#f92672">=</span> service_account<span style="color:#f92672">.</span>Credentials<span style="color:#f92672">.</span>from_service_account_file(service_account_credential_file, scopes<span style="color:#f92672">=</span>scopes)
</span></span><span style="display:flex;"><span>        request <span style="color:#f92672">=</span> google<span style="color:#f92672">.</span>auth<span style="color:#f92672">.</span>transport<span style="color:#f92672">.</span>requests<span style="color:#f92672">.</span>Request()
</span></span><span style="display:flex;"><span>        creds<span style="color:#f92672">.</span>refresh(request)
</span></span><span style="display:flex;"><span>        access_token <span style="color:#f92672">=</span> creds<span style="color:#f92672">.</span>token
</span></span><span style="display:flex;"><span>        token_obj <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;token&#34;</span>: access_token, <span style="color:#e6db74">&#34;expiry&#34;</span>: creds<span style="color:#f92672">.</span>expiry<span style="color:#f92672">.</span>replace(tzinfo<span style="color:#f92672">=</span>timezone<span style="color:#f92672">.</span>utc)<span style="color:#f92672">.</span>timestamp()}
</span></span><span style="display:flex;"><span>        f <span style="color:#f92672">=</span> open(access_token_file, <span style="color:#e6db74">&#34;w&#34;</span>)
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(json<span style="color:#f92672">.</span>dumps(token_obj))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> access_token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do</span>(self):
</span></span><span style="display:flex;"><span>        access_token <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(access_token_file):
</span></span><span style="display:flex;"><span>            f <span style="color:#f92672">=</span> open(access_token_file, <span style="color:#e6db74">&#34;r&#34;</span>)
</span></span><span style="display:flex;"><span>            token_obj <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>load(f)
</span></span><span style="display:flex;"><span>            access_token <span style="color:#f92672">=</span> token_obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;token&#34;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>            now <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>now(timezone<span style="color:#f92672">.</span>utc)<span style="color:#f92672">.</span>timestamp()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> int(token_obj<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;expiry&#34;</span>, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">&lt;</span> int(now) <span style="color:#f92672">-</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>:
</span></span><span style="display:flex;"><span>                access_token <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>__writeObj()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            access_token <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>__writeObj()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> access_token:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#34;No access token.&#34;</span>)
</span></span><span style="display:flex;"><span>            sys<span style="color:#f92672">.</span>exit()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Credentials(access_token)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service <span style="color:#f92672">=</span> build(<span style="color:#e6db74">&#34;drive&#34;</span>, <span style="color:#e6db74">&#34;v3&#34;</span>, credentials<span style="color:#f92672">=</span>GetCredential()<span style="color:#f92672">.</span>do())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Sample for using Drive API.</span>
</span></span><span style="display:flex;"><span>res <span style="color:#f92672">=</span> service<span style="color:#f92672">.</span>files()<span style="color:#f92672">.</span>list(pageSize<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, fields<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;files(name)&#34;</span>)<span style="color:#f92672">.</span>execute()
</span></span><span style="display:flex;"><span>print(res)
</span></span></code></pre></div><p>In this sample script, the file list is retrieved using the retrieved access token using googleapis for Python. The flow of this script is as follows.</p>
<ol>
<li>
<p>When this script is run for the first time, the access token is retrieved from the server side with the service account, and the retrieved access token is stored in the file of <code>access_token_file</code>. And, the file list of Google Drive of the service account is retrieved with the access token.</p>
</li>
<li>
<p>When this script is run, again, when the expiration time is not finished the access token is retrieved from the file of <code>access_token_file</code>. And, the file list of Google Drive of the service account is retrieved with the access token.</p>
</li>
<li>
<p>When this script is run, again, when the expiration time has already finished, the access token is retrieved from the server side with the service account. And, the file list of the Google Drive of the service account is retrieved with the access token.</p>
</li>
</ol>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2023%2f02%2f16%2fusing-until-expiration-time-of-access-token-retrieved-by-googleapis-for-python%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2023%2f02%2f16%2fusing-until-expiration-time-of-access-token-retrieved-by-googleapis-for-python%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2023%2f02%2f16%2fusing-until-expiration-time-of-access-token-retrieved-by-googleapis-for-python%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2023%2f02%2f16%2fusing-until-expiration-time-of-access-token-retrieved-by-googleapis-for-python%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2023%2f02%2f16%2fusing-until-expiration-time-of-access-token-retrieved-by-googleapis-for-python%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2023%2f02%2f16%2fusing-until-expiration-time-of-access-token-retrieved-by-googleapis-for-python%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2023/02/15/issue-of-html-form-with-input-tab-of-type-file-with-google.script.run/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2023/02/15/issue-of-html-form-with-input-tab-of-type-file-with-google.script.run/">Issue of HTML form with Input tab of Type File with google.script.run</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>








</body>
</html>

