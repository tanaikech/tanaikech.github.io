<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Taming the Wild Output: Effective Control of Gemini API Response Formats with response_schema &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/tanaikech" rel="me" target="_blank"><i class="fab fa-twitter-square fa-fw"></i>X</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Taming the Wild Output: Effective Control of Gemini API Response Formats with response_schema</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>21 May 2024, 15:57</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gemini">Gemini</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/ai">AI</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/llm">LLM</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/c99089b7b82562bfc5bf5c4bd8306c07">Gists</a></p>
<p><img src="https://tanaikech.github.io/image-storage/20240521a/fig1.jpg" alt=""></p>
<h1 id="abstract">Abstract</h1>
<p>The Gemini API traditionally required specific prompts for desired output formats. This report explores two new GenerationConfig properties: &ldquo;response_mime_type&rdquo; and &ldquo;response_schema&rdquo;. These allow developers to directly specify formats like JSON, enhancing control and predictability. We analyze and compare the effectiveness of both properties for controlling Gemini API output formats.</p>
<h1 id="introduction">Introduction</h1>
<p>One of the key challenges when working with the Gemini API is ensuring the output data is delivered in the format your application requires. Traditionally, the response format heavily relied on the specific prompt you provided. For example, retrieving data as a structured JSON object necessitated including a &ldquo;Return JSON&rdquo; prompt within your input text. This approach could be cumbersome and error-prone if the desired format wasn&rsquo;t explicitly requested.</p>
<p>To address this limitation, a new property called &ldquo;response_mime_type&rdquo; was recently introduced as part of the GenerationConfig configuration. <a href="https://ai.google.dev/api/rest/v1beta/GenerationConfig">Ref</a> and <a href="https://ai.google.dev/gemini-api/docs/api-overview#json">Ref</a> This property, along with supported JSON schemas, allows you to explicitly specify the desired output format, such as JSON. <a href="https://medium.com/google-cloud/taming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response-mime-type-da273c08be85">Ref</a> This enhancement significantly improves the controllability and predictability of the Gemini API&rsquo;s response format.</p>
<p>Further expanding on output format control, a new property named &ldquo;response_schema&rdquo; (both &ldquo;response_schema&rdquo; and &ldquo;responseSchema&rdquo; are accepted) has recently been added to the GenerationConfig configuration. <a href="https://ai.google.dev/api/rest/v1beta/GenerationConfig">Ref</a> According to the official documentation, it offers an alternative approach for controlling the output format.</p>
<p>This report builds upon my previous work on specifying output types for Gemini API using Google Apps Script. Here, we will compare and analyze the results of using &ldquo;response_schema&rdquo; against JSON schemas for controlling Gemini API output formats.</p>
<h1 id="usage">Usage</h1>
<p>In order to test this script, please do the following flow.</p>
<h2 id="1-create-an-api-key">1. Create an API key</h2>
<p>Please access <a href="https://ai.google.dev/gemini-api/docs/api-key">https://ai.google.dev/gemini-api/docs/api-key</a> and create your API key. At that time, please enable Generative Language API at the API console. This API key is used for this sample script.</p>
<p>This official document can be also seen. <a href="https://ai.google.dev/">Ref</a>.</p>
<h2 id="2-create-a-google-apps-script-project">2. Create a Google Apps Script project</h2>
<p>In this report, Google Apps Script is used. Of course, the method introducing this report can be also used in other languages.</p>
<p>Here, in order to test the following sample scripts, please create a standalone Google Apps Script project. Of course, this script can be also used with the container-bound script.</p>
<p>And, please open the script editor of the Google Apps Script project.</p>
<h2 id="3-sample-json-schema">3. Sample JSON schema</h2>
<p>The sample JSON schema using in this report is as follows. This schema is used for the following 2 sample scripts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sampleSchema</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;List 5 popular cookie recipes by including the following properties. Don&#39;t change properties and don&#39;t add other proeprties.&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;array&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">items</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Cookie recipes.&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">recipe_name</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Names of recipe.&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">materials</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Requirement materials for running the recipe.&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;array&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">items</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Don&#39;t add other proeprties.&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">material</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Requirement material for running the recipe.&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">amount</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Requirement amount of material for running the recipe. Unit is grams.&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;number&#34;</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">cost</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Cost of requirement material for running the recipe. Unit is dollar.&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;number&#34;</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">required</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;material&#34;</span>, <span style="color:#e6db74">&#34;amount&#34;</span>, <span style="color:#e6db74">&#34;cost&#34;</span>],
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">total_cost</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Total cost of materials.&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;number&#34;</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">required</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;recipe_name&#34;</span>, <span style="color:#e6db74">&#34;materials&#34;</span>, <span style="color:#e6db74">&#34;total_cost&#34;</span>],
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="a-use-response_mime_type-and-json-schema">A. Use response_mime_type and JSON schema</h3>
<p>This is the same with <a href="https://medium.com/google-cloud/taming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response-mime-type-da273c08be85">my previous report</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sampleA</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>; <span style="color:#75715e">// Please set your API key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">model</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;models/gemini-1.5-pro-latest&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">version</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;v1beta&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">prompt</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`Follow JSON schema.&lt;JSONSchema&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sampleSchema</span>
</span></span><span style="display:flex;"><span>  )<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/JSONSchema&gt;`</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`https://generativelanguage.googleapis.com/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">model</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:generateContent?key=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">contents</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">prompt</span> }] }],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">generationConfig</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">response_mime_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span> },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">payload</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">contentType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">muteHttpExceptions</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UrlFetchApp</span>.<span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">options</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">candidates</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">parts</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">parts</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">res</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;No response.&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When this script is run, the following result is obtained.</p>
<pre tabindex="0"><code>[
  {
    &#34;recipe_name&#34;: &#34;Chocolate Chip Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: 250, &#34;cost&#34;: 2.0 }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: 150, &#34;cost&#34;: 1.5 }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: 125, &#34;cost&#34;: 3.0 }, { &#34;material&#34;: &#34;Chocolate Chips&#34;, &#34;amount&#34;: 200, &#34;cost&#34;: 4.0 }, { &#34;material&#34;: &#34;Eggs&#34;, &#34;amount&#34;: 2, &#34;cost&#34;: 1.0 }],
    &#34;total_cost&#34;: 11.5
  },
  {
    &#34;recipe_name&#34;: &#34;Peanut Butter Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: 200, &#34;cost&#34;: 1.8 }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: 100, &#34;cost&#34;: 1.0 }, { &#34;material&#34;: &#34;Peanut Butter&#34;, &#34;amount&#34;: 150, &#34;cost&#34;: 3.5 }, { &#34;material&#34;: &#34;Eggs&#34;, &#34;amount&#34;: 1, &#34;cost&#34;: 0.5 }],
    &#34;total_cost&#34;: 6.8
  },
  {
    &#34;recipe_name&#34;: &#34;Oatmeal Raisin Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: 175, &#34;cost&#34;: 1.6 }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: 125, &#34;cost&#34;: 1.25 }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: 100, &#34;cost&#34;: 2.5 }, { &#34;material&#34;: &#34;Oatmeal&#34;, &#34;amount&#34;: 150, &#34;cost&#34;: 2.0 }, { &#34;material&#34;: &#34;Raisins&#34;, &#34;amount&#34;: 100, &#34;cost&#34;: 2.5 }],
    &#34;total_cost&#34;: 9.85
  },
  {
    &#34;recipe_name&#34;: &#34;Sugar Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: 260, &#34;cost&#34;: 2.1 }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: 175, &#34;cost&#34;: 1.75 }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: 125, &#34;cost&#34;: 3.0 }, { &#34;material&#34;: &#34;Eggs&#34;, &#34;amount&#34;: 1, &#34;cost&#34;: 0.5 }],
    &#34;total_cost&#34;: 7.35
  },
  {
    &#34;recipe_name&#34;: &#34;Snickerdoodle Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: 250, &#34;cost&#34;: 2.0 }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: 150, &#34;cost&#34;: 1.5 }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: 125, &#34;cost&#34;: 3.0 }, { &#34;material&#34;: &#34;Cinnamon&#34;, &#34;amount&#34;: 10, &#34;cost&#34;: 1.0 }],
    &#34;total_cost&#34;: 7.5
  }
]
</code></pre><p>In this sample script, the prompt is very simple like <code>Follow JSON schema.&lt;JSONSchema&gt;${JSON.stringify(sampleSchema)}&lt;/JSONSchema&gt;</code>. And, the result with the expected JSON structure could be obtained every run. From this result, it was found that Gemini API can correctly understand the JSON schema. The actual JSON schema is more complicated. So, when the JSON schema is used, for example, the excluded values will be also able to be set.</p>
<h3 id="b-use-response_mime_type-and-response_schema">B. Use response_mime_type and &ldquo;response_schema&rdquo;</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sampleB</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>; <span style="color:#75715e">// Please set your API key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">model</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;models/gemini-1.5-pro-latest&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">version</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;v1beta&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">prompt</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;List 5 popular cookie recipes by including the following properties. Requirement materials for running the recipe. Requirement material for running the recipe. Requirement amount of material for running the recipe. Unit is grams. Cost of requirement material for running the recipe. Unit is dollar. Total cost of materials.&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`https://generativelanguage.googleapis.com/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">model</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:generateContent?key=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">contents</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">prompt</span> }] }],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">generationConfig</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">response_mime_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">response_schema</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sampleSchema</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">payload</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">contentType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">muteHttpExceptions</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UrlFetchApp</span>.<span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">options</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">candidates</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">parts</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">parts</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>)));
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;No response.&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When this script is run, the following result is obtained.</p>
<pre tabindex="0"><code>[
  {
    &#34;cookie_name&#34;: &#34;Chocolate Chip Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: &#34;250&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.50&#34; }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: &#34;200&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.00&#34; }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: &#34;150&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;2.00&#34; }, { &#34;material&#34;: &#34;Eggs&#34;, &#34;amount&#34;: &#34;2&#34;, &#34;unit&#34;: &#34;pieces&#34;, &#34;cost&#34;: &#34;1.00&#34; }, { &#34;material&#34;: &#34;Chocolate Chips&#34;, &#34;amount&#34;: &#34;200&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;2.50&#34; }],
    &#34;total_cost&#34;: &#34;8.00&#34;
  },
  {
    &#34;cookie_name&#34;: &#34;Peanut Butter Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: &#34;200&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.20&#34; }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: &#34;150&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;0.75&#34; }, { &#34;material&#34;: &#34;Peanut Butter&#34;, &#34;amount&#34;: &#34;200&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;3.00&#34; }, { &#34;material&#34;: &#34;Eggs&#34;, &#34;amount&#34;: &#34;1&#34;, &#34;unit&#34;: &#34;pieces&#34;, &#34;cost&#34;: &#34;0.50&#34; }],
    &#34;total_cost&#34;: &#34;5.45&#34;
  },
  {
    &#34;cookie_name&#34;: &#34;Oatmeal Raisin Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: &#34;150&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;0.90&#34; }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: &#34;100&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;0.50&#34; }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: &#34;100&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.33&#34; }, { &#34;material&#34;: &#34;Eggs&#34;, &#34;amount&#34;: &#34;2&#34;, &#34;unit&#34;: &#34;pieces&#34;, &#34;cost&#34;: &#34;1.00&#34; }, { &#34;material&#34;: &#34;Oats&#34;, &#34;amount&#34;: &#34;100&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.00&#34; }, { &#34;material&#34;: &#34;Raisins&#34;, &#34;amount&#34;: &#34;50&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;0.75&#34; }],
    &#34;total_cost&#34;: &#34;5.48&#34;
  },
  {
    &#34;cookie_name&#34;: &#34;Sugar Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: &#34;300&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.80&#34; }, { &#34;material&#34;: &#34;Sugar&#34;, &#34;amount&#34;: &#34;250&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.25&#34; }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: &#34;200&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;2.66&#34; }, { &#34;material&#34;: &#34;Eggs&#34;, &#34;amount&#34;: &#34;1&#34;, &#34;unit&#34;: &#34;pieces&#34;, &#34;cost&#34;: &#34;0.50&#34; }],
    &#34;total_cost&#34;: &#34;6.21&#34;
  },
  {
    &#34;cookie_name&#34;: &#34;Gingerbread Cookies&#34;,
    &#34;materials&#34;: [{ &#34;material&#34;: &#34;Flour&#34;, &#34;amount&#34;: &#34;250&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.50&#34; }, { &#34;material&#34;: &#34;Brown Sugar&#34;, &#34;amount&#34;: &#34;150&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;0.75&#34; }, { &#34;material&#34;: &#34;Butter&#34;, &#34;amount&#34;: &#34;100&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.33&#34; }, { &#34;material&#34;: &#34;Molasses&#34;, &#34;amount&#34;: &#34;100&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;1.50&#34; }, { &#34;material&#34;: &#34;Ginger&#34;, &#34;amount&#34;: &#34;5&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;0.20&#34; }, { &#34;material&#34;: &#34;Cinnamon&#34;, &#34;amount&#34;: &#34;5&#34;, &#34;unit&#34;: &#34;grams&#34;, &#34;cost&#34;: &#34;0.15&#34; }],
    &#34;total_cost&#34;: &#34;5.43&#34;
  }
]
</code></pre><p>In this sample script, the prompt is <code>List 5 popular cookie recipes by including the following properties. Requirement materials for running the recipe. Requirement material for running the recipe. Requirement amount of material for running the recipe. Unit is grams. Cost of requirement material for running the recipe. Unit is dollar. Total cost of materials. </code>. Also, the JSON structure was sometimes changed every run. And, the unexpected property names were used. For example, there was a case that the property &ldquo;instructions&rdquo; was added and how to cook was set as the value, also, there was a case that the result value is not an array like <code>{&quot;popular_cookie_recipes&quot;:[{&quot;recipe_name&quot;:,,,]}}</code>. As additional information, when <code>Follow response schema.</code> is used as the prompt, the completely unexpected answers are returned while the output format is JSON including the unexpected properties.</p>
<h1 id="summary">Summary</h1>
<p>From these results, it was found that when you want to always obtain the output values in a consistent JSON format, the combination of &ldquo;response_mime_type&rdquo; set to &ldquo;application/json&rdquo; and JSON schema is a suitable approach. In this case, the JSON schema is used in the prompt to define the desired structure of the output.</p>
<p>On the other hand, if you want to obtain the output values with a JSON structure that might include more information than expected, the combination of &ldquo;response_mime_type&rdquo; set to &ldquo;application/json&rdquo; and &ldquo;response_schema&rdquo; is more suitable. In this scenario, the JSON schema is provided to the &ldquo;response_schema&rdquo; parameter.</p>
<p>The Gemini API is under active development, and it is expected that future updates will provide more accurate control over the output format.</p>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2024%2f05%2f21%2ftaming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response_schema%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2024%2f05%2f21%2ftaming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response_schema%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f05%2f21%2ftaming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response_schema%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2024%2f05%2f21%2ftaming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response_schema%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f05%2f21%2ftaming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response_schema%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f05%2f21%2ftaming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response_schema%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2024/05/17/updated-gas-library-geminiwithfiles/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2024/05/17/updated-gas-library-geminiwithfiles/">Updated: GAS Library - GeminiWithFiles</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>






<script src="https://tanaikech.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

