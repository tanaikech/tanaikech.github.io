<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Flexible Labeling for Gmail using Gemini API with Google Apps Script Part 3 &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/tanaikech" rel="me" target="_blank"><i class="fa-brands fa-square-x-twitter"></i>X</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://medium.com/@tanaike" rel="me" target="_blank"><i class="fa-brands fa-medium"></i>Medium</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/tanaike" rel="me" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fa-brands fa-github"></i>GitHub</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://gist.github.com/tanaikech" rel="me" target="_blank"><i class="fas fa-code fa-fw"></i>Gists</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://dev.to/tanaike" rel="me" target="_blank"><i class="fa-brands fa-dev fa-fw"></i>DEV</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://zenn.dev/tanaike" rel="me" target="_blank"><i class="fas fa-edit fa-fw"></i>Zenn</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://devpost.com/kanshi000001" rel="me" target="_blank"><i class="fas fa-code fa-fw"></i>Devpost</a>
    </li>
    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Flexible Labeling for Gmail using Gemini API with Google Apps Script Part 3</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>19 Sep 2024, 12:02</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gemini">Gemini</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gmail">gmail</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/ed3fdd463b5965503c7b6f3b7db0d4f5">Gists</a></p>
<p><img src="https://tanaikech.github.io/image-storage/20240919a/fig1.png" alt=""></p>
<h1 id="abstract">Abstract</h1>
<p>This report improves Gmail email labeling with Gemini API using JSON schema and leverages advancements in Gemini 1.5 Flash for faster processing.</p>
<h1 id="introduction">Introduction</h1>
<p>As Gemini continues to evolve, existing scripts utilizing its capabilities can be revisited to improve efficiency and accuracy. This includes the process of flexible labeling for Gmail emails using the Gemini API. I have previously explored this topic in two reports:</p>
<ul>
<li>December 19, 2023: Demonstrating Gmail label selection based solely on prompts. <a href="https://medium.com/google-cloud/flexible-labeling-for-gmail-using-gemini-pro-api-with-google-apps-script-5bf2ee7c9f52">Ref</a></li>
<li>January 30, 2024: Exploring label selection through both semantic search and function calls. <a href="https://medium.com/google-cloud/flexible-labeling-for-gmail-using-gemini-pro-api-with-google-apps-script-part-2-08015af6b2e6">Ref</a></li>
</ul>
<p>This report introduces a new method for Gmail label selection using a JSON schema with response_mime_type: &ldquo;application/json&rdquo;. Thanks to Gemini&rsquo;s advancements, content generation speed has significantly improved with the introduction of Gemini 1.5 Flash. Additionally, JSON schema allows for greater control over the output format. Recent research <a href="https://medium.com/google-cloud/taming-the-wild-output-effective-control-of-gemini-api-response-formats-with-response-schema-ae0097b97502">Ref</a> suggests that this combination outperforms the previous approach using response_mime_type and response_schema separately.</p>
<p>To facilitate the use of the Gemini API with Google Apps Script, a custom library named &ldquo;GeminiWithFiles&rdquo; was created. <a href="https://medium.com/google-cloud/batch-processing-powerhouse-leverage-gemini-1-5-2857fd7fe28d">Ref</a> and <a href="https://github.com/tanaikech/GeminiWithFiles">Ref</a> This library is also utilized within this report.</p>
<p>This report concludes by presenting the latest script for flexible Gmail email labeling using the Gemini API with Google Apps Script.</p>
<h1 id="repository">Repository</h1>
<p>The repository of this script is <a href="https://github.com/tanaikech/Flexible-Labeling-for-Gmail-using-Gemini-API-with-Google-Apps-Script-Part-3">here</a>.</p>
<h1 id="feature">Feature</h1>
<p>The feature of this script is as follows.</p>
<ul>
<li><strong>Automated Gmail Labeling</strong>: Automatically add labels to Gmails using the Gemini API with Google Apps Script.</li>
<li><strong>Batch Processing</strong>: Process multiple emails efficiently with a single API call. <a href="https://medium.com/google-cloud/batch-processing-powerhouse-leverage-gemini-1-5-2857fd7fe28d">Ref</a></li>
<li><strong>Structured Data Handling</strong>: Utilize JSON schemas for both input and output data with the Gemini API.</li>
<li><strong>Scheduled Execution</strong>: Leverage time-driven triggers for automatic script execution.</li>
<li><strong>Cost-Effective and Accurate</strong>: Achieve low processing costs and high accuracy through Gemini 1.5 Flash, JSON schemas, and batch processing.</li>
</ul>
<h1 id="usage">Usage</h1>
<h2 id="1-create-a-google-apps-script-project">1. Create a Google Apps Script project</h2>
<p>Please create a Google Apps Script project. In this case, both the container-bound script and the standalone script can be used.</p>
<h2 id="2-create-an-api-key">2. Create an API key</h2>
<p>Please access <a href="https://ai.google.dev/gemini-api/docs/api-key">https://ai.google.dev/gemini-api/docs/api-key</a> and create your API key. At that time, please enable Generative Language API at the API console. This API key is used for this sample script.</p>
<p>This official document can also be seen. <a href="https://ai.google.dev/">Ref</a>.</p>
<p>Of course, if you can link the Google Cloud Platform Project to the Google Apps Script Project in the copied Spreadsheet, you can also use the access token.</p>
<h2 id="3-install-a-google-apps-script-library">3. Install a Google Apps Script library</h2>
<p>In this script, a Google Apps Script library GeminiWithFiles is used. Please install it. You can see how to install it <a href="https://github.com/tanaikech/GeminiWithFiles?tab=readme-ov-file#1-use-geminiwithfiles-as-a-google-apps-script-library">here</a>.</p>
<h2 id="4-script-class-object">4. Script: Class object</h2>
<p>This is the class object. Please copy and paste the following script to the script editor of your created Google Apps Script project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Class object for automtically adding labels to Gmail using Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Author: Kanshi Tanaike
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Repository: https://github.com/tanaikech/Flexible-Labeling-for-Gmail-using-Gemini-API-with-Google-Apps-Script-Part-3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AddLabel</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param {Object} object Object using this script.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param {String} object.functionName Function name of the function you run.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param {String} object.apiKey API key for using Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param {Object[]} object.labelObj Label names on Gmail and the description of the label.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param {Number} object.n Number of emails in one API call. Default is 5.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * @param {Number} object.triggerTime Cycle time for executing the script. Default is 10. The unit is minute.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">object</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @private */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @private */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">now</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Date();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @private */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">PropertiesService</span>.<span style="color:#a6e22e">getScriptProperties</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** @private */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;prev&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Main method.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @return {String} Return result value.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checkObject_</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">messages</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getNewMessages_</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">callGemini_</span>(<span style="color:#a6e22e">messages</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">setTrigger_</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">functionName</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Check the inputted object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @private
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">checkObject_</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">functionName</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Please set functionName.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Please set apiKey.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">labelObj</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">labelObj</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Please set valid labelObj.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">labelObj</span>.<span style="color:#a6e22e">some</span>(({ <span style="color:#a6e22e">label</span> }) =&gt; <span style="color:#a6e22e">label</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;INBOX&#34;</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">labelObj</span>.<span style="color:#a6e22e">push</span>({ <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;INBOX&#34;</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Others&#34;</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">n</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">triggerTime</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">triggerTime</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Get threads of Gmail.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @return {Object} Return an object including thread IDs and messages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @private
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">getNewMessages_</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nowTime</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">prev</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">prev</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nowTime</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>; <span style="color:#75715e">// If you run this script for the first time or prev is undefined, emails from your inbox in the past 1 hour are retrieved.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">threads</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GmailApp</span>.<span style="color:#a6e22e">getInboxThreads</span>().<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">t</span> =&gt; <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">getLastMessageDate</span>().<span style="color:#a6e22e">getTime</span>() <span style="color:#f92672">&gt;</span> Number(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">prev</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">setProperty</span>(<span style="color:#e6db74">&#34;prev&#34;</span>, <span style="color:#a6e22e">nowTime</span>.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">threads</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">threads</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">thread</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastMessageDate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">thread</span>.<span style="color:#a6e22e">getLastMessageDate</span>().<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastMessage</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">thread</span>.<span style="color:#a6e22e">getMessages</span>().<span style="color:#a6e22e">find</span>((<span style="color:#a6e22e">m</span>) =&gt; <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">getDate</span>().<span style="color:#a6e22e">getTime</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">lastMessageDate</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">threadId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">thread</span>.<span style="color:#a6e22e">getId</span>(), <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">lastMessage</span>.<span style="color:#a6e22e">getPlainBody</span>() };
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Request Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Array} labelObj Array including label names.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Array} messages Array including thread IDs and messages from Gmail.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @return {Object} Return an object including thread IDs and messages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @private
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">createPrompt_</span>(<span style="color:#a6e22e">labelObj</span>, <span style="color:#a6e22e">messages</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">jsonSchema1</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Emails including threadId and message.&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;array&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">items</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">threadId</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Thread ID of Gmail.&#34;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span> },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Email body.&#34;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span> },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">jsonSchema2</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;List of labels including descriptions of the labels.&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;array&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">items</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Label name.&#34;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span> },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Description of the label.&#34;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span> },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">jsonSchema3</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`Select the label names from &#34;Array1&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;array&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">items</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Selected label name.&#34;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span> },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">threadId</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Thread ID of Gmail.&#34;</span>, <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span> },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">prompt</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Run the following steps in order.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`1. Read and understand the messages from the following array including JSON data &#34;Array1&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&lt;Array1&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">messages</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/Array1&gt;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`JSON schema &#34;JsonSchema1&#34; of this array is as following JSON schema &#34;JsonSchema1&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&lt;JsonSchema1&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">jsonSchema1</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/JsonSchema1&gt;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`2. Read and understand the following array &#34;Array2&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&lt;Array2&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">labelObj</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/Array2&gt;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`JSON schema &#34;JsonSchema2&#34; of this array is as following JSON schema &#34;JsonSchema2&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&lt;JsonSchema2&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">jsonSchema2</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/JsonSchema2&gt;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`3. For each element in &#34;Array1&#34;, export a single element including the selected label from &#34;Array2&#34; strongly related to the message.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Output the result with the following JSON schema &#34;JsonSchema3&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&lt;JsonSchema3&gt;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">jsonSchema3</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/JsonSchema3&gt;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&lt;IMPORTANT&gt;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`- One element in &#34;Array1&#34; must have only one label name.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`- Length of &#34;Array1&#34; must be the same length of output array &#34;JsonSchema3&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&lt;/IMPORTANT&gt;`</span>,
</span></span><span style="display:flex;"><span>    ].<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#34;\n&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">prompt</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Request Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Array} messages Array including thread IDs and messages from Gmail.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @return {Object} Return an object including thread IDs and messages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @private
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">callGemini_</span>(<span style="color:#a6e22e">messages</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">messages</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">splitMessages</span> <span style="color:#f92672">=</span> [...Array(Math.<span style="color:#a6e22e">ceil</span>(<span style="color:#a6e22e">messages</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">n</span>))].<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">_</span> =&gt; <span style="color:#a6e22e">messages</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">n</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">splitMessages</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">msgs</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">createPrompt_</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">labelObj</span>, <span style="color:#a6e22e">msgs</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">g</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">GeminiWithFiles</span>.<span style="color:#a6e22e">geminiWithFiles</span>({ <span style="color:#a6e22e">apiKey</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">apiKey</span>, <span style="color:#a6e22e">response_mime_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>, <span style="color:#a6e22e">exportTotalTokens</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">returnValue</span>, <span style="color:#a6e22e">usageMetadata</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">generateContent</span>({ <span style="color:#a6e22e">q</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">returnValue</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">returnValue</span>)) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Gemini returns invalid value. Those mails will be processed again.&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">setProperty</span>(<span style="color:#e6db74">&#34;prev&#34;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">prev</span>.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">returnValue</span>.<span style="color:#a6e22e">forEach</span>(({ <span style="color:#a6e22e">label</span>, <span style="color:#a6e22e">threadId</span> }) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">label</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">label</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;INBOX&#34;</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GmailApp</span>.<span style="color:#a6e22e">getThreadById</span>(<span style="color:#a6e22e">threadId</span>);
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Mail subject: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">thread</span>.<span style="color:#a6e22e">getMessages</span>()[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">getSubject</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">, labeled to &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">label</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;`</span>);
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Token information for Gemini: totalTokenCount is </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">usageMetadata</span>.<span style="color:#a6e22e">totalTokenCount</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.`</span>);
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GmailApp</span>.<span style="color:#a6e22e">getUserLabelByName</span>(<span style="color:#a6e22e">label</span>) <span style="color:#f92672">||</span> <span style="color:#a6e22e">GmailApp</span>.<span style="color:#a6e22e">createLabel</span>(<span style="color:#a6e22e">label</span>);
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">GmailApp</span>.<span style="color:#a6e22e">getThreadById</span>(<span style="color:#a6e22e">threadId</span>).<span style="color:#a6e22e">moveToArchive</span>().<span style="color:#a6e22e">addLabel</span>(<span style="color:#a6e22e">l</span>).<span style="color:#a6e22e">refresh</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">now</span>.<span style="color:#a6e22e">toISOString</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">len</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> mails were processed.`</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Request Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {String} functionName Function name.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @private
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setTrigger_</span>(<span style="color:#a6e22e">functionName</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ScriptApp</span>.<span style="color:#a6e22e">getProjectTriggers</span>().<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">t</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">getHandlerFunction</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">functionName</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ScriptApp</span>.<span style="color:#a6e22e">deleteTrigger</span>(<span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ScriptApp</span>.<span style="color:#a6e22e">newTrigger</span>(<span style="color:#a6e22e">functionName</span>).<span style="color:#a6e22e">timeBased</span>().<span style="color:#a6e22e">everyMinutes</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">triggerTime</span>).<span style="color:#a6e22e">create</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="5-script-main-function">5. Script: Main function</h2>
<p>This is the main function for using the above class object. Please copy and paste the following script to the script editor of your created Google Apps Script project.</p>
<p>Please set your values to the function <code>main</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">functionName</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;main&#34;</span>; <span style="color:#75715e">// Please set the function name of this function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Please set your API key for using Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Please set your label names on Gmail and the description of the label. Please modify this for your situation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">labelObj</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    { <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;academic&#34;</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Related to university, laboratory, research, education, and etc.&#34;</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;commission&#34;</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Related to a comission, a request, a job offer, orders, and etc.&#34;</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;advertisement&#34;</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Related to advertisement, new product, and etc.&#34;</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;INBOX&#34;</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Others&#34;</span> },
</span></span><span style="display:flex;"><span>  ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>; <span style="color:#75715e">// Number of emails in one API call.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">triggerTime</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>; <span style="color:#75715e">// In this case, the script is automatically run every 10 minutes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">AddLabel</span>({ <span style="color:#a6e22e">functionName</span>, <span style="color:#a6e22e">apiKey</span>, <span style="color:#a6e22e">labelObj</span>, <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">triggerTime</span> }).<span style="color:#a6e22e">run</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">res</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="6-testing">6: Testing</h2>
<p>When you manually run <code>main</code> function, the emails are retrieved from &ldquo;INBOX&rdquo; of Gmail. And, those mails are processed and your inputted labels are added to the emails. And, the time-driven trigger for automatically executing the script is also installed. By this, the script <code>main</code> is automatically run by the installed time-driven trigger.</p>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2024%2f09%2f19%2fflexible-labeling-for-gmail-using-gemini-api-with-google-apps-script-part-3%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2024%2f09%2f19%2fflexible-labeling-for-gmail-using-gemini-api-with-google-apps-script-part-3%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f09%2f19%2fflexible-labeling-for-gmail-using-gemini-api-with-google-apps-script-part-3%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2024%2f09%2f19%2fflexible-labeling-for-gmail-using-gemini-api-with-google-apps-script-part-3%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f09%2f19%2fflexible-labeling-for-gmail-using-gemini-api-with-google-apps-script-part-3%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f09%2f19%2fflexible-labeling-for-gmail-using-gemini-api-with-google-apps-script-part-3%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2024/09/17/simplifying-spreadsheet-management-introducing-a-google-apps-script-automation/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2024/09/17/simplifying-spreadsheet-management-introducing-a-google-apps-script-automation/">Simplifying Spreadsheet Management: Introducing a Google Apps Script Automation</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://tanaikech.github.io/2024/09/25/harnessing-geminis-power-a-guide-to-generating-content-from-structured-data/">Harnessing Gemini&#39;s Power: A Guide to Generating Content from Structured Data</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://tanaikech.github.io/2024/09/25/harnessing-geminis-power-a-guide-to-generating-content-from-structured-data/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>






<script src="https://tanaikech.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

