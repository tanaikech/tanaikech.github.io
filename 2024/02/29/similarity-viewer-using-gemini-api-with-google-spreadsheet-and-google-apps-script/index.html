<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Similarity Viewer using Gemini API with Google Spreadsheet and Google Apps Script &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/tanaikech" rel="me" target="_blank"><i class="fa-brands fa-square-x-twitter fa-fw"></i>X</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Similarity Viewer using Gemini API with Google Spreadsheet and Google Apps Script</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>29 Feb 2024, 11:22</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>&nbsp;&#47;
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/spreadsheet">spreadsheet</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gemini">Gemini</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/spreadsheet">spreadsheet</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/6a7afe7b145170265ee3cb2d6cb4be58">Gists</a></p>
<p><img src="https://tanaikech.github.io/image-storage/20240229a/fig1.gif" alt=""></p>
<h1 id="abstract">Abstract</h1>
<p>The Gemini API enables both content generation and semantic search, managing data effectively. This report introduces a Gemini-powered similarity viewer for easy visualization of complex text similarity scores, using Google Spreadsheet and Apps Script.</p>
<h1 id="introduction">Introduction</h1>
<p>The Gemini API unlocks new possibilities, extending its capabilities beyond content generation to encompass semantic search. Within this context, the API excels at efficiently managing data within corpora. While semantic search provides valuable similarity scores (chunkRelevanceScore) for text pairs, interpreting these numerical values can be cumbersome. This report addresses this challenge by introducing a novel similarity viewer, built upon the powerful trio of Gemini API, Google Spreadsheet, and Google Apps Script. This user-friendly tool allows us to visually represent the similarity of texts, transforming numerical data into an intuitive and easily digestible format.</p>
<h1 id="usage">Usage</h1>
<h2 id="1-create-a-gas-project">1. Create a GAS project.</h2>
<p>Please create a new Google Spreadsheet and open the script editor.</p>
<h2 id="2-linking-google-cloud-platform-project-to-google-apps-script-project-for-new-ide">2. Linking Google Cloud Platform Project to Google Apps Script Project for New IDE</h2>
<p>In this case, you can see how to do this at <a href="https://github.com/tanaikech/Linking-Google-Cloud-Platform-Project-to-Google-Apps-Script-Project-for-New-IDE">my repository</a>.</p>
<p>Also, please enable Generative Language API at the API console.</p>
<p>After the above setting, the following sample script can be used.</p>
<h2 id="3-install-library">3. Install library</h2>
<p>In this script, in order to manage Corpora, a Google Apps Script library of CorporaApp is used. Please install the library. You can see how to install it at <a href="https://github.com/tanaikech/CorporaApp?tab=readme-ov-file#usage">my repository</a>.</p>
<p>Library&rsquo;s project key is <strong><code>1XrAybct1KUwGcFrEZ9BOd5sa0SoHeQwGhOWkDOHki9lDFAX9OHlO03y_</code></strong>.</p>
<p>When you install this library, the following required scopes are automatically installed.</p>
<ul>
<li><code>https://www.googleapis.com/auth/script.external_request</code></li>
<li><code>https://www.googleapis.com/auth/generative-language.retriever</code></li>
</ul>
<h2 id="4-prepare-a-sample-data">4. Prepare a sample data</h2>
<p>In order to test this script, I prepared sample data in a spreadsheet using Gemini.</p>
<p>The sample data includes columns for:</p>
<ul>
<li>I asked <code>Return 20 kinds of dogs as text words.</code>, and I put the returned values in column &ldquo;A&rdquo;.</li>
<li>I asked <code>Return 20 kinds of explanations about dogs without using a word of dog within 50 words of text, respectively.</code>, and I put the returned values to column &ldquo;B&rdquo;.</li>
</ul>
<p>Similar sample data was created for &ldquo;cats,&rdquo; &ldquo;birds,&rdquo; and &ldquo;fruits&rdquo; following the same process. The following image is the created sample.</p>
<p><img src="https://tanaikech.github.io/image-storage/20240229a/fig2.png" alt=""></p>
<h2 id="5-script">5. Script</h2>
<p>In this script, there are 2 parts of Google Apps Script and HTML. So, please copy and paste them respectively.</p>
<h3 id="google-apps-script-codegs">Google Apps Script: <code>Code.gs</code></h3>
<p>Please copy and paste the following script to <code>Code.gs</code> on the script editor.</p>
<p>In this script, a corpus of <code>corpora/sample-serviceaccount-1</code> and a document of <code>corpora/sample-serviceaccount-1/documents/sample-serviceaccount-1</code> in the corpus are created. The chunks are stored in the document.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Create a custom menu by the simple trigger of OnOpen.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">onOpen</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SpreadsheetApp</span>.<span style="color:#a6e22e">getUi</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">createMenu</span>(<span style="color:#e6db74">&#34;Similarity Viewer&#34;</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">addItem</span>(<span style="color:#e6db74">&#34;run&#34;</span>, <span style="color:#e6db74">&#34;openSidebar&#34;</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">addToUi</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Open sidebar on Google Spreadsheet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">openSidebar</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">html</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HtmlService</span>.<span style="color:#a6e22e">createHtmlOutputFromFile</span>(<span style="color:#e6db74">&#34;index&#34;</span>).<span style="color:#a6e22e">setTitle</span>(<span style="color:#e6db74">&#34;Similarity Viewer&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">SpreadsheetApp</span>.<span style="color:#a6e22e">getUi</span>().<span style="color:#a6e22e">showSidebar</span>(<span style="color:#a6e22e">html</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * The values of accessToken, newCorpusName, newDocumentName are returned.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {Object} Object including accessToken, newCorpusName, newDocumentName.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">init_</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">accessToken</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ScriptApp</span>.<span style="color:#a6e22e">getOAuthToken</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newCorpusName</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;corpora/sample-serviceaccount-1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">displayName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sample corpus serviceaccount 1&#34;</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">newDocumentName</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">newCorpusName</span>.<span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/documents/sample-serviceaccount-1`</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">displayName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sample document serviceaccount 1&#34;</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">accessToken</span>, <span style="color:#a6e22e">newCorpusName</span>, <span style="color:#a6e22e">newDocumentName</span> };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Cell values of the active sheet are stored to a document in Corpus with Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Number} headerRows Number of the header rows in the active sheet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">synchronize</span>(<span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">accessToken</span>, <span style="color:#a6e22e">newCorpusName</span>, <span style="color:#a6e22e">newDocumentName</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">init_</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ca</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">CorporaApp</span>.<span style="color:#a6e22e">setAccessToken</span>(<span style="color:#a6e22e">accessToken</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">getDocuments</span>(<span style="color:#a6e22e">newCorpusName</span>.<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res2</span>.<span style="color:#a6e22e">find</span>(({ <span style="color:#a6e22e">name</span> }) =&gt; <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">newDocumentName</span>.<span style="color:#a6e22e">name</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">deleteDocument</span>(<span style="color:#a6e22e">newDocumentName</span>.<span style="color:#a6e22e">name</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">createDocument</span>(<span style="color:#a6e22e">newCorpusName</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">newDocumentName</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sheet</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SpreadsheetApp</span>.<span style="color:#a6e22e">getActiveSheet</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">values</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sheet</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">getRange</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sheet</span>.<span style="color:#a6e22e">getLastRow</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">headerRows</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sheet</span>.<span style="color:#a6e22e">getLastColumn</span>()
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">getDisplayValues</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">requests</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">values</span>.<span style="color:#a6e22e">flatMap</span>((<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">i</span>) =&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">j</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">parent</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">newDocumentName</span>.<span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">chunk</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">stringValue</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">c</span> },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">customMetadata</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">key</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;range&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">stringValue</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({ <span style="color:#a6e22e">row</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">col</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> }),
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">setChunks</span>(<span style="color:#a6e22e">newDocumentName</span>.<span style="color:#a6e22e">name</span>, { <span style="color:#a6e22e">requests</span> });
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Search texts by a text using Gemini API. And, the results are shown as the background colors of cells and notes on the cells.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Object} o Object including headerRows, searchText, threshold from HTML side.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">search</span>(<span style="color:#a6e22e">o</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">headerRows</span>, <span style="color:#a6e22e">searchText</span>, <span style="color:#a6e22e">threshold</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">o</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">accessToken</span>, <span style="color:#a6e22e">newDocumentName</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">init_</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ca</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">CorporaApp</span>.<span style="color:#a6e22e">setAccessToken</span>(<span style="color:#a6e22e">accessToken</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ca</span>.<span style="color:#a6e22e">searchQueryFromDocument</span>(<span style="color:#a6e22e">newDocumentName</span>.<span style="color:#a6e22e">name</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">query</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">searchText</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resultsCount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span>,
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rows</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">relevantChunks</span>.<span style="color:#a6e22e">map</span>(
</span></span><span style="display:flex;"><span>    ({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">chunk</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">stringValue</span> },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">customMetadata</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">chunkRelevanceScore</span>,
</span></span><span style="display:flex;"><span>    }) =&gt; ({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">stringValue</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">chunkRelevanceScore</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">range</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">customMetadata</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">stringValue</span>),
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rowData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">range</span> }) =&gt; <span style="color:#a6e22e">range</span>.<span style="color:#a6e22e">row</span>).<span style="color:#a6e22e">sort</span>((<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) =&gt; <span style="color:#a6e22e">a</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">b</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">minRow</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rowData</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maxRow</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rowData</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">range</span> }) =&gt; <span style="color:#a6e22e">range</span>.<span style="color:#a6e22e">col</span>).<span style="color:#a6e22e">sort</span>((<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) =&gt; <span style="color:#a6e22e">a</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">b</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">minCol</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">colData</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maxCol</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">colData</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">backgrounds</span> <span style="color:#f92672">=</span> [...Array(<span style="color:#a6e22e">maxRow</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">minRow</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)].<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">_</span>) =&gt; [
</span></span><span style="display:flex;"><span>    ...Array(<span style="color:#a6e22e">maxCol</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">minCol</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">fill</span>(<span style="color:#66d9ef">null</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">notes</span> <span style="color:#f92672">=</span> [...Array(<span style="color:#a6e22e">maxRow</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">minRow</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)].<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">_</span>) =&gt; [
</span></span><span style="display:flex;"><span>    ...Array(<span style="color:#a6e22e">maxCol</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">minCol</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">fill</span>(<span style="color:#66d9ef">null</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">chunkRelevanceScores</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rows</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">chunkRelevanceScore</span> }) =&gt; <span style="color:#a6e22e">chunkRelevanceScore</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">sort</span>((<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) =&gt; <span style="color:#a6e22e">a</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">b</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">minChunkRelevanceScore</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chunkRelevanceScores</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">maxChunkRelevanceScore</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chunkRelevanceScores</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">step</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">maxChunkRelevanceScore</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">minChunkRelevanceScore</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rgbToHex</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">g</span>, <span style="color:#a6e22e">b</span>) =&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;#&#34;</span> <span style="color:#f92672">+</span> ((<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">|</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> (<span style="color:#a6e22e">g</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> <span style="color:#a6e22e">b</span>).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>).<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">1</span>); <span style="color:#75715e">// ref: https://stackoverflow.com/a/5624139
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">g</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">round</span>(
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">chunkRelevanceScore</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">minChunkRelevanceScore</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">step</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> { ...<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">rgb</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rgbToHex</span>(<span style="color:#ae81ff">255</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">g</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">g</span>) };
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">res2</span>.<span style="color:#a6e22e">forEach</span>(({ <span style="color:#a6e22e">range</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">row</span>, <span style="color:#a6e22e">col</span> }, <span style="color:#a6e22e">rgb</span>, <span style="color:#a6e22e">chunkRelevanceScore</span> }) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">notes</span>[<span style="color:#a6e22e">row</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>][<span style="color:#a6e22e">col</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">chunkRelevanceScore</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">chunkRelevanceScore</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">threshold</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">backgrounds</span>[<span style="color:#a6e22e">row</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>][<span style="color:#a6e22e">col</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">rgb</span>;
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sheet</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SpreadsheetApp</span>.<span style="color:#a6e22e">getActiveSheet</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sheet</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">getRange</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sheet</span>.<span style="color:#a6e22e">getLastRow</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">headerRows</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sheet</span>.<span style="color:#a6e22e">getLastColumn</span>()
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setBackground</span>(<span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setNote</span>(<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sheet</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">getRange</span>(<span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">backgrounds</span>.<span style="color:#a6e22e">length</span>, <span style="color:#a6e22e">backgrounds</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">length</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setBackgrounds</span>(<span style="color:#a6e22e">backgrounds</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setNotes</span>(<span style="color:#a6e22e">notes</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Reset background colors and notes of the cells.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Number} headerRows Number of the header rows in the active sheet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">reset</span>(<span style="color:#a6e22e">headerRows</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sheet</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SpreadsheetApp</span>.<span style="color:#a6e22e">getActiveSheet</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sheet</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">getRange</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sheet</span>.<span style="color:#a6e22e">getLastRow</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">headerRows</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sheet</span>.<span style="color:#a6e22e">getLastColumn</span>()
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setBackground</span>(<span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setNote</span>(<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="html-indexhtml">HTML: <code>index.html</code></h3>
<p>Please copy and paste the following HTML to <code>index.html</code> on the script editor. In this sample,
<a href="https://materializecss.com/">materialize</a> is used for creating the interface on the sidebar.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">base</span> <span style="color:#a6e22e">target</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_top&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">link</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rel</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css&#34;</span>
</span></span><span style="display:flex;"><span>    /&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">link</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://fonts.googleapis.com/icon?family=Material+Icons&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rel</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;stylesheet&#34;</span>
</span></span><span style="display:flex;"><span>    /&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">style</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">body</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">letter-spacing</span>: <span style="color:#ae81ff">0.15</span><span style="color:#66d9ef">rem</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">container</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">margin-bottom</span>: <span style="color:#ae81ff">10</span><span style="color:#66d9ef">px</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">style</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">header</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">h5</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;header center light-blue-text text-darken-4&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        Similarity Viewer
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">h5</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">header</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;container&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input-field col s6&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">input</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;number&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;headerRows&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;headerRows&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;validate&#34;</span>
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;headerRows&#34;</span>&gt;Set header rows.&lt;/<span style="color:#f92672">label</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input-field col s6&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">input</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;search&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;search&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;validate&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">step</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;any&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">required</span>
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;search&#34;</span>&gt;Set search text.&lt;/<span style="color:#f92672">label</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input-field col s6&#34;</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">input</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;number&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;threshold&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;threshold&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;validate&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">step</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;any&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">required</span>
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">label</span> <span style="color:#a6e22e">for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;threshold&#34;</span>&gt;Set threshold.&lt;/<span style="color:#f92672">label</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;waves-effect waves-light btn-small&#34;</span> <span style="color:#a6e22e">onclick</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;run(this)&#34;</span>&gt;run&lt;/<span style="color:#f92672">a</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;waves-effect waves-light btn-small&#34;</span> <span style="color:#a6e22e">onclick</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;reset(this)&#34;</span>
</span></span><span style="display:flex;"><span>        &gt;reset&lt;/<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>      &gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;container&#34;</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;waves-effect waves-light btn-small&#34;</span> <span style="color:#a6e22e">onclick</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;synchronize(this)&#34;</span>
</span></span><span style="display:flex;"><span>        &gt;&lt;<span style="color:#f92672">i</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;material-icons left&#34;</span>&gt;cloud&lt;/<span style="color:#f92672">i</span>&gt;Synchronize corpus&lt;/<span style="color:#f92672">a</span>
</span></span><span style="display:flex;"><span>      &gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">synchronize</span>(<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PROCESSING...&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">pointerEvents</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">=</span> Number(
</span></span><span style="display:flex;"><span>          document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;headerRows&#34;</span>).<span style="color:#a6e22e">value</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">google</span>.<span style="color:#a6e22e">script</span>.<span style="color:#a6e22e">run</span>
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">withSuccessHandler</span>((<span style="color:#a6e22e">_</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">innerHTML</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#39;&lt;i class=&#34;material-icons left&#34;&gt;cloud&lt;/i&gt;Synchronize corpus&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">pointerEvents</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auto&#34;</span>;
</span></span><span style="display:flex;"><span>          })
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">synchronize</span>(<span style="color:#a6e22e">headerRows</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>(<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PROCESSING...&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">pointerEvents</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">=</span> Number(document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;headerRows&#34;</span>).<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">searchText</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;search&#34;</span>).<span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">threshold</span> <span style="color:#f92672">=</span> Number(document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;threshold&#34;</span>).<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">searchText</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;run&#34;</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">pointerEvents</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auto&#34;</span>;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">google</span>.<span style="color:#a6e22e">script</span>.<span style="color:#a6e22e">run</span>
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">withSuccessHandler</span>((<span style="color:#a6e22e">_</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;run&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">pointerEvents</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auto&#34;</span>;
</span></span><span style="display:flex;"><span>          })
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">search</span>({ <span style="color:#a6e22e">headerRows</span>, <span style="color:#a6e22e">searchText</span>, <span style="color:#a6e22e">threshold</span> });
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">reset</span>(<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PROCESSING...&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">pointerEvents</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">headerRows</span> <span style="color:#f92672">=</span> Number(document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;headerRows&#34;</span>).<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">google</span>.<span style="color:#a6e22e">script</span>.<span style="color:#a6e22e">run</span>
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">withSuccessHandler</span>((<span style="color:#a6e22e">_</span>) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">textContent</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;reset&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">pointerEvents</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;auto&#34;</span>;
</span></span><span style="display:flex;"><span>          })
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">reset</span>(<span style="color:#a6e22e">headerRows</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;
</span></span></code></pre></div><h2 id="6-testing">6. Testing</h2>
<p>You can see the demonstration in the top image in this report.
Please do the following steps.</p>
<ol>
<li>When you open the Google Spreadsheet, a custom menu is created. Selecting &ldquo;Run&rdquo; from the &ldquo;Similarity Viewer&rdquo; opens a sidebar.</li>
<li>If the first row of your active sheet is a header row, set &ldquo;Set header rows&rdquo; to 1.</li>
<li>To store the cell values in the corpus, click the &ldquo;SYNCHRONIZE CORPUS&rdquo; button. This stores the values from the active sheet in the created corpus.</li>
<li>Enter your search text in the &ldquo;Set search text&rdquo; field.</li>
<li>Set the threshold (e.g., 0.5) in the &ldquo;Set threshold&rdquo; field. This value corresponds to the chunkRelevanceScore.</li>
<li>Click the &ldquo;RUN&rdquo; button. This sets background colors and notes on the active sheet based on the chunkRelevanceScore.</li>
<li>You can adjust the threshold (chunkRelevanceScore) by checking the background colors and notes on the cells.</li>
</ol>
<p>The intensity of the color indicates the value of chunkRelevanceScore: darker green signifies a higher score, and lighter green signifies a lower score. You can close to the expected result by adjusting the search text and the threshold. These search text and the threshold can be also used to <a href="https://ai.google.dev/api/rest/v1beta/models/generateAnswer">Method: models.generateAnswer</a>.</p>
<h1 id="note">Note</h1>
<p>The current maximum number of chunks is 1,000,000. However, due to the current maximum of 100 returned chunks for both the <a href="https://ai.google.dev/api/rest/v1beta/corpora/query">corpora.query</a> and <a href="https://ai.google.dev/api/rest/v1beta/corpora.documents/query">corpora.documents.query</a> methods, adjusting the threshold easily is crucial for achieving the desired results.</p>
<p>The current version of the Gemini API for managing Corpora is &ldquo;v1beta.&rdquo; While the above information is from the reference <a href="https://ai.google.dev/api/rest">Ref</a>, updates may occur in the future.</p>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2024%2f02%2f29%2fsimilarity-viewer-using-gemini-api-with-google-spreadsheet-and-google-apps-script%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2024%2f02%2f29%2fsimilarity-viewer-using-gemini-api-with-google-spreadsheet-and-google-apps-script%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f02%2f29%2fsimilarity-viewer-using-gemini-api-with-google-spreadsheet-and-google-apps-script%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2024%2f02%2f29%2fsimilarity-viewer-using-gemini-api-with-google-spreadsheet-and-google-apps-script%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f02%2f29%2fsimilarity-viewer-using-gemini-api-with-google-spreadsheet-and-google-apps-script%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f02%2f29%2fsimilarity-viewer-using-gemini-api-with-google-spreadsheet-and-google-apps-script%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2024/02/26/updated-gas-library-corporaapp/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2024/02/26/updated-gas-library-corporaapp/">Updated: GAS Library - CorporaApp</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://tanaikech.github.io/2024/03/03/technique-for-protecting-google-spreadsheet-using-google-apps-script/">Technique for Protecting Google Spreadsheet using Google Apps Script</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://tanaikech.github.io/2024/03/03/technique-for-protecting-google-spreadsheet-using-google-apps-script/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>






<script src="https://tanaikech.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

