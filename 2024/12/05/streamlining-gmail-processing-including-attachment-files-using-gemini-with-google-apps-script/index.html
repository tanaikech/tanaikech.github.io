<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Streamlining Gmail Processing Including Attachment Files Using Gemini with Google Apps Script &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/tanaikech" rel="me" target="_blank"><i class="fab fa-twitter-square fa-fw"></i>X</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Streamlining Gmail Processing Including Attachment Files Using Gemini with Google Apps Script</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>05 Dec 2024, 10:14</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>&nbsp;&#47;
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/spreadsheet">spreadsheet</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/spreadsheet">spreadsheet</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gmail">gmail</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gemini">Gemini</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/f2161b110257e282b71ce1e6d0082a51">Gists</a></p>
<p><img src="https://tanaikech.github.io/image-storage/20241205a/fig1.jpg" alt=""></p>
<h1 id="abstract">Abstract</h1>
<p>A new library, MimeTypeApp, simplifies using Gmail messages and attachments with the Gemini API for tasks like text analysis. It converts unsupported formats for seamless integration with Google Apps Script and Gemini.</p>
<h1 id="introduction">Introduction</h1>
<p>Recently, I published MimeTypeApp, a Google Apps Script library that simplifies parsing Gmail messages, including attachments, for use with the Gemini API. <a href="https://github.com/tanaikech/MimeTypeApp">Ref</a> This library addresses a key challenge: Gmail attachments come in various MIME types, while the Gemini API currently only accepts a limited set for processing. MimeTypeApp bridges this gap by providing functions to convert unsupported MIME types to formats compatible with Gemini. With MimeTypeApp, you can streamline your workflows that involve parsing Gmail messages and their attachments for tasks like text extraction, summarization, or sentiment analysis using the Gemini API. This report introduces a sample script that demonstrates how to leverage MimeTypeApp to achieve this functionality. By leveraging Google Apps Script&rsquo;s integration capabilities, MimeTypeApp allows you to create powerful applications that seamlessly connect Gmail, Spreadsheets (for storing results or extracted data), and the Gemini API.</p>
<h1 id="flow">Flow</h1>
<p><img src="https://tanaikech.github.io/image-storage/20241205a/fig2.png" alt=""></p>
<p>This is a flow diagram of the script. This script is run with Google Apps Script.</p>
<ol>
<li>Retrieve emails from Gmail.</li>
<li>Retrieve the metadata, the email body, and the attachment files from each email.</li>
<li>When the attachment files are included in the email, convert the attachment files to PDF format.</li>
<li>Upload the converted files including the email body to Gemini.</li>
<li>Summary the email body and the attachment files by generating content with Gemini API.</li>
<li>Put the result into the Data sheet.</li>
</ol>
<h1 id="usage">Usage</h1>
<h2 id="1-create-an-api-key">1. Create an API key</h2>
<p>Please access <a href="https://ai.google.dev/gemini-api/docs/api-key">https://ai.google.dev/gemini-api/docs/api-key</a> and create your API key. At that time, please enable Generative Language API at the API console. This API key is used for the following scripts.</p>
<p>This official document can also be seen. <a href="https://ai.google.dev/">Ref</a>.</p>
<h2 id="2-sample-script">2. Sample script</h2>
<p>In this case, you can get the script by copying a Google Spreadsheet. This Spreadsheet includes the script. The URL for copying is as follows.</p>
<p><strong><a href="https://docs.google.com/spreadsheets/d/1D3GB0KCnBcZdd7OF0iLiYR_of0RY2xTyzlr5bgLtAdw/copy">https://docs.google.com/spreadsheets/d/1D3GB0KCnBcZdd7OF0iLiYR_of0RY2xTyzlr5bgLtAdw/copy</a></strong></p>
<p>When you open this Spreadsheet, you can see a &ldquo;Data&rdquo; sheet which has the header row.</p>
<p>When you open the script editor of this Spreadsheet, you can see the following script files.</p>
<ul>
<li><code>Code.gs</code>: This includes the main methods.</li>
<li><code>MimeTypeApp.gs</code>: This is from <a href="https://github.com/tanaikech/MimeTypeApp">MimeTypeApp (Author: me)</a>.</li>
<li><code>GeminiWithFiles.gs</code>: This is from <a href="https://github.com/tanaikech/GeminiWithFiles">GeminiWithFiles (Author: me)</a>.</li>
</ul>
<h2 id="3-set-api-key">3. Set API key</h2>
<p>Please open the script editor and set your API key to <code>apiKey</code> in <code>Code.gs</code>.</p>
<h2 id="4-script">4. Script</h2>
<p>The scripts of <code>MimeTypeApp.gs</code> and <code>GeminiWithFiles.gs</code> can be seen at <a href="https://github.com/tanaikech/MimeTypeApp">here</a> and <a href="https://github.com/tanaikech/GeminiWithFiles">here</a>, respectively. Here, the script in <code>Code.gs</code> is shown as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Javascript" data-lang="Javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * First, please set your API key for using Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This is a sample script for parsing emails including attachment files using Gemini with Google Apps Script.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * The parsed data is put into the Data sheet of the active Spreadsheet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Author: Tanaike
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Retrieve current data from Spreadsheet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SpreadsheetApp</span>.<span style="color:#a6e22e">getActiveSpreadsheet</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dataSheet</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ss</span>.<span style="color:#a6e22e">getSheetByName</span>(<span style="color:#e6db74">&#34;Data&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastRowDataSheet</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataSheet</span>.<span style="color:#a6e22e">getLastRow</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rows</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataSheet</span>.<span style="color:#a6e22e">getRange</span>(<span style="color:#e6db74">&#34;A2:G&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">lastRowDataSheet</span>).<span style="color:#a6e22e">getValues</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">messageIds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">map</span>(([, <span style="color:#a6e22e">id</span>]) =&gt; <span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastRow</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rows</span>[<span style="color:#a6e22e">rows</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">now</span> <span style="color:#f92672">=</span> Date.<span style="color:#a6e22e">now</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">startTime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">now</span> <span style="color:#f92672">-</span> (<span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">lastRow</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">lastRow</span>[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">instanceof</span> Date) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">startTime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lastRow</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Setting for Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">responseSchema</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;JSON schema of the result value.&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;array&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">items</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">filename</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Filename&#34;</span> },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">summary</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Created summary&#34;</span> },
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">forGeminiObject</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">apiKey</span>, <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;models/gemini-1.5-flash-002&#34;</span>, <span style="color:#a6e22e">responseMimeType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>, <span style="color:#a6e22e">responseSchema</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Retrieve emails from Gmail.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// In this sample, emails received after the previous process are processed. When the script is run for the first time, emails received before the previous hour are processed. Of course, you can edit this search query to fit your situation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">threads</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GmailApp</span>.<span style="color:#a6e22e">search</span>(<span style="color:#e6db74">`after:</span><span style="color:#e6db74">${</span>Math.<span style="color:#a6e22e">floor</span>(<span style="color:#a6e22e">startTime</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">threads</span>.<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">ar</span>, <span style="color:#a6e22e">thread</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">thread</span>.<span style="color:#a6e22e">getMessages</span>().<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">message</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getId</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">messageIds</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">id</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getDate</span>(), <span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getSubject</span>(), <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getFrom</span>()];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getBody</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blobs</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">Utilities</span>.<span style="color:#a6e22e">newBlob</span>(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">HTML</span>, <span style="color:#e6db74">&#34;HTMLBody_GmailMessage.html&#34;</span>)];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Retrieve the attachments of Google Docs files.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ats</span> <span style="color:#f92672">=</span> [...<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">matchAll</span>(<span style="color:#e6db74">/&#34;https:\/\/drive\.google\.com\/open\?id\=(.*?)&#34;/g</span>)];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ats</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileIds</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ats</span>.<span style="color:#a6e22e">map</span>(([, <span style="color:#a6e22e">id</span>]) =&gt; <span style="color:#a6e22e">id</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">blobs</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MimeTypeApp</span>().<span style="color:#a6e22e">setFileIds</span>(<span style="color:#a6e22e">fileIds</span>).<span style="color:#a6e22e">getAs</span>({ <span style="color:#a6e22e">mimeType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PDF</span> }));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Retrieve the attachments except for Google Docs files.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">attachments</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getAttachments</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">attachments</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validMimeTypes</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PLAIN_TEXT</span>, <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PDF</span>, <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PNG</span>, <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">JPEG</span>, <span style="color:#e6db74">&#34;audio/mpeg&#34;</span>, <span style="color:#e6db74">&#34;video/mp4&#34;</span>];
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">validFiles</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">attachments</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">b</span> =&gt; <span style="color:#a6e22e">validMimeTypes</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">getContentType</span>()));
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">validFiles</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">blobs</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#a6e22e">validFiles</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">invalidFiles</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">attachments</span>.<span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">b</span> =&gt; <span style="color:#f92672">!</span><span style="color:#a6e22e">validMimeTypes</span>.<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">getContentType</span>()));
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">invalidFiles</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">blobs</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MimeTypeApp</span>().<span style="color:#a6e22e">setBlobs</span>(<span style="color:#a6e22e">invalidFiles</span>).<span style="color:#a6e22e">getAs</span>({ <span style="color:#a6e22e">mimeType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PDF</span> }));
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Generate content with Gemini.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">g</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">GeminiWithFiles</span>(<span style="color:#a6e22e">forGeminiObject</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileList</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">setBlobs</span>(<span style="color:#a6e22e">blobs</span>).<span style="color:#a6e22e">uploadFiles</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">`Run the following steps.`</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">`1. Understand the uploaded files.`</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">`2. Summary each uploaded files within 50 words.`</span>,
</span></span><span style="display:flex;"><span>        ].<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#34;\n&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">withUploadedFilesByGenerateContent</span>(<span style="color:#a6e22e">fileList</span>).<span style="color:#a6e22e">generateContent</span>({ <span style="color:#a6e22e">q</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">find</span>(({ <span style="color:#a6e22e">filename</span> }) =&gt; <span style="color:#a6e22e">filename</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;HTMLBody_GmailMessage.html&#34;</span>)<span style="color:#f92672">?</span>.<span style="color:#a6e22e">summary</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">attach</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">filter</span>(({ <span style="color:#a6e22e">filename</span> }) =&gt; <span style="color:#a6e22e">filename</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;HTMLBody_GmailMessage.html&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">attach</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">attach</span>.<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">summary</span> }) =&gt; <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">filename</span><span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">summary</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#34;\n&#34;</span>) <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">value</span>.<span style="color:#a6e22e">push</span>(<span style="color:#e6db74">`https://mail.google.com/mail/#search/rfc822msgid:</span><span style="color:#e6db74">${</span>encodeURIComponent(<span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;Message-ID&#34;</span>))<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ar</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`Message </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> was processed.`</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ar</span>;
</span></span><span style="display:flex;"><span>  }, []);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dataSheet</span>.<span style="color:#a6e22e">getRange</span>(<span style="color:#a6e22e">lastRowDataSheet</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">length</span>, <span style="color:#a6e22e">v</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">length</span>).<span style="color:#a6e22e">setValues</span>(<span style="color:#a6e22e">v</span>);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;No emails.&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Create a custom menu for the active Spreadsheet.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">onOpen</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SpreadsheetApp</span>.<span style="color:#a6e22e">getUi</span>().<span style="color:#a6e22e">createMenu</span>(<span style="color:#e6db74">&#34;run&#34;</span>).<span style="color:#a6e22e">addItem</span>(<span style="color:#e6db74">&#34;Run script&#34;</span>, <span style="color:#e6db74">&#34;run&#34;</span>).<span style="color:#a6e22e">addToUi</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To generate the email body and attachment descriptions, the Gemini API was utilized with the following configuration:</p>
<ul>
<li><strong>Model:</strong> <code>models/gemini-1.5-flash-002</code></li>
<li><strong>Response MIME Type:</strong> <code>application/json</code></li>
<li><strong>Response Schema:</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;JSON schema of the result value.&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;array&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;items&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;filename&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>, <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Filename&#34;</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;summary&#34;</span>: { <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>, <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Created summary&#34;</span> }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In this setting, the batch process can be achieved. So, both the email body and all attachment files can be processed by one API call.</p>
<p><strong>Rationale for Using <code>responseSchema</code>:</strong></p>
<p>Based on current observations, the <code>responseSchema</code> approach appears to yield more reliable results than directly incorporating JSON schema into the prompt. However, it&rsquo;s important to note that this might change in future API updates.</p>
<h2 id="5-testing">5. Testing</h2>
<p>When the function <code>run</code> is run, when you have several emails, the following result is obtained.</p>
<p><img src="https://tanaikech.github.io/image-storage/20241205a/fig3.png" alt=""></p>
<p>The texts summarized email body and attachment files are put into the Data sheet. When the function <code>run</code> is run again, the emails after the last execution are retrieved. Also, you can directly check the email by &ldquo;Message URL&rdquo;.</p>
<p>Also, these summarized data can be used for the semantic search of emails including the attachment files.</p>
<h1 id="additional-information">Additional information</h1>
<p>When you run the function <code>run</code> by <a href="https://developers.google.com/apps-script/guides/triggers/installable">the time-driven trigger</a>, the emails can be automatically parsed into the Google Spreadsheet.</p>
<h1 id="note">Note</h1>
<ul>
<li>The top image was created by imagen3.</li>
</ul>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2024%2f12%2f05%2fstreamlining-gmail-processing-including-attachment-files-using-gemini-with-google-apps-script%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2024%2f12%2f05%2fstreamlining-gmail-processing-including-attachment-files-using-gemini-with-google-apps-script%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f12%2f05%2fstreamlining-gmail-processing-including-attachment-files-using-gemini-with-google-apps-script%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2024%2f12%2f05%2fstreamlining-gmail-processing-including-attachment-files-using-gemini-with-google-apps-script%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f12%2f05%2fstreamlining-gmail-processing-including-attachment-files-using-gemini-with-google-apps-script%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f12%2f05%2fstreamlining-gmail-processing-including-attachment-files-using-gemini-with-google-apps-script%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2024/12/04/mimetypeapp-flexible-mimetype-converter-with-google-apps-script/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2024/12/04/mimetypeapp-flexible-mimetype-converter-with-google-apps-script/">MimeTypeApp: Flexible MimeType Converter with Google Apps Script</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>






<script src="https://tanaikech.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

