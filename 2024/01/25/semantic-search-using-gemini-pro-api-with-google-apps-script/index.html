<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Semantic Search using Gemini Pro API with Google Apps Script &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/tanaikech" rel="me" target="_blank"><i class="fab fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Semantic Search using Gemini Pro API with Google Apps Script</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>25 Jan 2024, 12:17</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>&nbsp;&#47;
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/document">document</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gemini">Gemini</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/ai">AI</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/llm">LLM</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/document">document</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/c6556dc08ae3dcb013d8909c1f42b16d">Gists</a></p>
<p><img src="https://tanaikech.github.io/image-storage/20240125a/fig1.png" alt=""></p>
<h1 id="abstract">Abstract</h1>
<p>Gemini API unlocks semantic search for Google Apps Script, boosting its power beyond automation. This report explores the result of attempting the semantic search using Gemini Pro API with Google Apps Script.</p>
<h1 id="introduction">Introduction</h1>
<p>The recent release of the LLM model Gemini as an API on Vertex AI and Google AI Studio opens a world of possibilities. <a href="https://deepmind.google/technologies/gemini/#introduction">Ref</a> and <a href="https://blog.google/technology/ai/google-gemini-ai/#sundar-note">Ref</a> I believe Gemini API significantly expands the potential of Google Apps Script and paves the way for diverse applications. In this report, I present a result for attempting the semantic search using Gemini Pro API with Google Apps Script.</p>
<p>Google Apps Script is one of the powerful automation tools for achieving the automation process. Also, Google Apps Script can manage Google Docs (Documents, Spreadsheets, Slides, Forms, and so on) even when users are away from their computers. In the current stage, there are no built-in methods for the semantic search, yet. When Google Apps Script can be used for achieving the semantic search, it is considered that achieving this will expand the management of Google Docs and the development of various applications created by Google Apps Script.</p>
<p>This report delves into the implementation of the semantic search by leveraging Gemini API with Google Apps Script.</p>
<h1 id="usage">Usage</h1>
<p>In order to test this script, please do the following flow.</p>
<h2 id="1-create-an-api-key">1. Create an API key</h2>
<p>Please access <a href="https://makersuite.google.com/app/apikey">https://makersuite.google.com/app/apikey</a> and create your API key. At that time, please enable Generative Language API at the API console. This API key is used for this sample script.</p>
<p>This official document can be also seen. <a href="https://ai.google.dev/">Ref</a>.</p>
<h2 id="2-create-a-google-apps-script-project">2. Create a Google Apps Script project</h2>
<p>Please create a standalone Google Apps Script project. Of course, this script can be also used with the container-bound script.</p>
<p>And, please open the script editor of the Google Apps Script project.</p>
<h2 id="3-sample-scripts">3. Sample scripts</h2>
<p>The base script is as follows. Please copy and paste the following script to the script editor, set your API key to the function <code>getEmbedding_</code>, and save the script.</p>
<p>In this sample, in order to evaluate the similarity of embedding values, the cosine similarity is calculated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Calculate cosine similarity from 2 arrays.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Array} array1 1-dimensional array.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Array} array2 1-dimensional array.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {Number} Calculated result of cosine similarity.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">cosineSimilarity_</span>(<span style="color:#a6e22e">array1</span>, <span style="color:#a6e22e">array2</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dotProduct</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">array1</span>.<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">i</span>) =&gt; (<span style="color:#a6e22e">t</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">array2</span>[<span style="color:#a6e22e">i</span>]), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">magnitudes</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">array1</span>, <span style="color:#a6e22e">array2</span>]
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">e</span>) =&gt; Math.<span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">f</span>) =&gt; (<span style="color:#a6e22e">t</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">f</span>), <span style="color:#ae81ff">0</span>)))
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">f</span>) =&gt; (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*=</span> <span style="color:#a6e22e">f</span>), <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dotProduct</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">magnitudes</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Request &#34;Method: models.embedContent&#34; of Gemini Pro API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {Object} requests Request body for Method: models.batchEmbedContents.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @return {Number} Embedding generated from the input texts.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getEmbedding_</span>(<span style="color:#a6e22e">requests</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>; <span style="color:#75715e">// Please set your API key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`https://generativelanguage.googleapis.com/v1/models/embedding-001:batchEmbedContents?key=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">payload</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({ <span style="color:#a6e22e">requests</span> }),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">contentType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UrlFetchApp</span>.<span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">options</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>()));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="a-retrieving-most-similar-text-using-a-search-text">A. Retrieving most similar text using a search text</h3>
<p>Please copy and paste the following script to the script editor. This script uses the above functions <code>getEmbedding_</code> and <code>cosineSimilarity_</code>.</p>
<p>When you run this script, please run <code>sample1</code>. In this sample, the value of <code>searchText</code> is searched from 9 texts in <code>texts</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sample1</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// This is a search text.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">searchText</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;car&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// These sample texts are generated by Gemini Pro API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">texts</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;car&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A machine with four wheels that is powered by an engine and is used to transport people or goods. It has a steering wheel, a braking system, and an acceleration system.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;plane&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A machine that flies through the air, powered by engines. It has wings that generate lift, and a tail that provides stability. It can carry people or cargo.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;dog&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A four-legged mammal that is domesticated and used as a companion or working animal. It has a keen sense of smell and hearing, and is often used for hunting, herding, or guarding.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;cat&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A small, furry mammal that is often kept as a pet. It is known for its independent nature, sharp claws, and hunting skills.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;bird&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A feathered creature that flies through the air. It has a beak, wings, and feathers. It builds nests and lays eggs.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;fish&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A cold-blooded vertebrate that lives in water. It has gills for breathing, fins for swimming, and scales for protection.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;human&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A bipedal, intelligent animal that is capable of complex thought and emotion. It is the only species on Earth that can use language, art, and technology.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;plant&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;An organism that is not an animal and does not move. It has cells with cell walls and uses photosynthesis to make its own food.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;cherry blossoms&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;A tree that blooms with delicate, colorful flowers in the spring. It is a symbol of beauty, renewal, and hope in many cultures.&#34;</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">r1</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;models/embedding-001&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">searchText</span> }] },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">taskType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;RETRIEVAL_QUERY&#34;</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">r2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">texts</span>.<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">title</span>, <span style="color:#a6e22e">text</span> }) =&gt; ({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;models/embedding-001&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span> }] },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">taskType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;RETRIEVAL_DOCUMENT&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">title</span>,
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getEmbedding_</span>([<span style="color:#a6e22e">r1</span>, ...<span style="color:#a6e22e">r2</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">ar1</span>, ...<span style="color:#a6e22e">ar2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">embeddings</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">e</span>) =&gt; <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">values</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ar2</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">ar</span>, <span style="color:#a6e22e">i</span>) =&gt; ({ <span style="color:#a6e22e">cs</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cosineSimilarity_</span>(<span style="color:#a6e22e">ar1</span>, <span style="color:#a6e22e">ar</span>), <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">texts</span>[<span style="color:#a6e22e">i</span>] }))
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">sort</span>((<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) =&gt; (<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">cs</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">cs</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>When this script is run with <code>seachTest</code> of <code>&quot;car&quot;, &quot;plane&quot;, &quot;dog&quot;, &quot;cat&quot;, &quot;bird&quot;, &quot;fish&quot;, &quot;human&quot;, &quot;plant&quot;, &quot;cherry blossoms&quot;</code>, it was confirmed that the correct texts related from the inputted texts are returned.</li>
<li>As in other search text, when &ldquo;toy poodle&rdquo; is used as <code>seachTest</code>, <code>{ title: &quot;dog&quot;, text: &quot;A four-legged mammal that is domesticated and used as a companion or working animal. It has a keen sense of smell and hearing, and is often used for hunting, herding, or guarding.&quot; }</code> is returned. Also, when <code>crow</code> is used, <code>{ title: 'bird', text: 'A feathered creature that flies through the air. It has a beak, wings, and feathers. It builds nests and lays eggs.' }</code> is returned.</li>
</ul>
<p>It seems that correct values are returned by the search text with the semantic search. Also, you can see that the words of <code>&quot;car&quot;, &quot;plane&quot;, &quot;dog&quot;, &quot;cat&quot;, &quot;bird&quot;, &quot;fish&quot;, &quot;human&quot;, &quot;plant&quot;, &quot;cherry blossoms&quot;</code> are not included in <code>texts</code>.</p>
<p>In this sample script, the following flow is run.</p>
<ol>
<li>Retrieve embedding values of <code>searchText</code> and <code>texts</code> using &ldquo;Method: models.batchEmbedContents&rdquo;.</li>
<li>Calculate the value of cosine similarity between the embedding value of <code>searchText</code> and the embedding values of <code>texts</code>.</li>
<li>Most similar text for <code>searchText</code> is retrieved using the calculation results.</li>
</ol>
<p>When &ldquo;Method: models.batchEmbedContents&rdquo; is used, the embedding values of all texts can be retrieved by one API call.</p>
<h3 id="b-highlighting-paragraph-in-google-documents">B. Highlighting paragraph in Google Documents</h3>
<p>Please copy and paste the following script to the script editor. This script uses the above functions <code>getEmbedding_</code> and <code>cosineSimilarity_</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sample2</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// This is a search text.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">searchText</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dog&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Please set your document ID.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">documentId</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">DocumentApp</span>.<span style="color:#a6e22e">openById</span>(<span style="color:#a6e22e">documentId</span>).<span style="color:#a6e22e">getBody</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">texts</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">getParagraphs</span>().<span style="color:#a6e22e">reduce</span>((<span style="color:#a6e22e">ar</span>, <span style="color:#a6e22e">p</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">text</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">getText</span>().<span style="color:#a6e22e">trim</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">text</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ar</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">text</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ar</span>;
</span></span><span style="display:flex;"><span>  }, []);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">r1</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;models/embedding-001&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">searchText</span> }] },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">taskType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;RETRIEVAL_QUERY&#34;</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">r2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">texts</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">text</span>) =&gt; ({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;models/embedding-001&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span> }] },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">taskType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;RETRIEVAL_DOCUMENT&#34;</span>,
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getEmbedding_</span>([<span style="color:#a6e22e">r1</span>, ...<span style="color:#a6e22e">r2</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">ar1</span>, ...<span style="color:#a6e22e">ar2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">embeddings</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">e</span>) =&gt; <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">values</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ar2</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">ar</span>, <span style="color:#a6e22e">i</span>) =&gt; ({ <span style="color:#a6e22e">cs</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cosineSimilarity_</span>(<span style="color:#a6e22e">ar1</span>, <span style="color:#a6e22e">ar</span>), <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">texts</span>[<span style="color:#a6e22e">i</span>] }))
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">sort</span>((<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) =&gt; (<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">cs</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">cs</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">findText</span>(<span style="color:#a6e22e">result</span>).<span style="color:#a6e22e">getElement</span>().<span style="color:#a6e22e">asText</span>().<span style="color:#a6e22e">setBackgroundColor</span>(<span style="color:#e6db74">&#34;#f4cccc&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This sample script runs the following flow.</p>
<ol>
<li>Retrieve paragraphs from a Google Document.</li>
<li>Search a paragraph using a search text.</li>
<li>Highlight the searched paragraph.</li>
</ol>
<p>When this script is run, the following result is obtained.</p>
<p><img src="https://tanaikech.github.io/image-storage/20240125a/fig2.png" alt=""></p>
<p>You can see that the paragraph of <code>A four-legged mammal that is domesticated and used as a companion or working animal. It has a keen sense of smell and hearing, and is often used for hunting, herding, or guarding.</code> is highlighted.</p>
<h3 id="c-semantic-search-of-image-files-on-google-drive">C. Semantic search of image files on Google Drive</h3>
<p>Please copy and paste the following script to the script editor. This script uses the above functions <code>getEmbedding_</code> and <code>cosineSimilarity_</code>.</p>
<p>Unfortunately, in the current stage (January 25, 2024), when the value of embedding of an image is tried to be retrieved, an error of <code>embedContent only supports `text` content.</code> occurs. I believe that this will be resolved in the future update. From this situation, as a workaround for the semantic search of the image files on Google Drive, I would like to introduce a simple sample script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// Please set the folder ID of folder including image files.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">folderId</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// First, please run this function. This function set the explanation of the image to the description of the file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sample_C1</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>; <span style="color:#75715e">// Please set your API key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">DriveApp</span>.<span style="color:#a6e22e">getFolderById</span>(<span style="color:#a6e22e">folderId</span>).<span style="color:#a6e22e">getFiles</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">token</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ScriptApp</span>.<span style="color:#a6e22e">getOAuthToken</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UrlFetchApp</span>.<span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`https://drive.google.com/thumbnail?sz=w1000&amp;id=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">getId</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>, { <span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">authorization</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Bearer &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">token</span> } }).<span style="color:#a6e22e">getContent</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">base64</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Utilities</span>.<span style="color:#a6e22e">base64Encode</span>(<span style="color:#a6e22e">bytes</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`https://generativelanguage.googleapis.com/v1/models/gemini-pro-vision:generateContent?key=</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">contents</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;What is this picture?&#34;</span> }, { <span style="color:#a6e22e">inline_data</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">mime_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;image/png&#34;</span>, <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">base64</span> } }] }] };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">payload</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">payload</span>), <span style="color:#a6e22e">contentType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UrlFetchApp</span>.<span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">options</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// console.log(res.getContentText())
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">r</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">content</span>.<span style="color:#a6e22e">parts</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">r</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">setDescription</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">trim</span>());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// After you ran &#34;sample_C1&#34;, please run this function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sample_C2</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// This is a search text.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">searchText</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dog&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">descriptions</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">DriveApp</span>.<span style="color:#a6e22e">getFolderById</span>(<span style="color:#a6e22e">folderId</span>).<span style="color:#a6e22e">getFiles</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">description</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">getDescription</span>().<span style="color:#a6e22e">trim</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">description</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">descriptions</span>.<span style="color:#a6e22e">push</span>({ <span style="color:#a6e22e">filename</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">getName</span>(), <span style="color:#a6e22e">fileId</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">getId</span>(), <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">description</span>, <span style="color:#a6e22e">request</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;models/embedding-001&#34;</span>, <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">description</span> }] }, <span style="color:#a6e22e">taskType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;RETRIEVAL_DOCUMENT&#34;</span> } });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">r1</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">model</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;models/embedding-001&#34;</span>, <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">searchText</span> }] }, <span style="color:#a6e22e">taskType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;RETRIEVAL_QUERY&#34;</span> };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getEmbedding_</span>([<span style="color:#a6e22e">r1</span>, ...<span style="color:#a6e22e">descriptions</span>.<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">request</span> }) =&gt; <span style="color:#a6e22e">request</span>)]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">ar1</span>, ...<span style="color:#a6e22e">ar2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">embeddings</span>.<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">e</span> =&gt; <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">values</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ar2</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">ar</span>, <span style="color:#a6e22e">i</span>) =&gt; ({ <span style="color:#a6e22e">cs</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">cosineSimilarity_</span>(<span style="color:#a6e22e">ar1</span>, <span style="color:#a6e22e">ar</span>), <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">descriptions</span>[<span style="color:#a6e22e">i</span>] })).<span style="color:#a6e22e">sort</span>((<span style="color:#a6e22e">a</span>, <span style="color:#a6e22e">b</span>) =&gt; <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">cs</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">cs</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cs</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">filename</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This script runs the following flow.</p>
<ol>
<li>Run <code>sample_C1</code>. The explanations of the image files in the folder are set as the description of the file.</li>
<li>Run <code>sample_C2</code>. Semantic search is run using the descriptions of the image files.</li>
<li>Return the filename as the search result. If you want to see the file ID, you can obtain it with <code>console.log(cs[0].file)</code>.</li>
</ol>
<h1 id="note">Note</h1>
<ul>
<li>In the current stage (January 25, 2024), when the value of embedding of an image is tried to be retrieved, an error of <code>embedContent only supports `text` content.</code> occurs. I believe that this will be resolved in the future update.</li>
</ul>
<h1 id="references">References</h1>
<ul>
<li><a href="https://ai.google.dev/api/rest/v1/models/batchEmbedContents">Method: models.batchEmbedContents</a></li>
</ul>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2024%2f01%2f25%2fsemantic-search-using-gemini-pro-api-with-google-apps-script%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2024%2f01%2f25%2fsemantic-search-using-gemini-pro-api-with-google-apps-script%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f01%2f25%2fsemantic-search-using-gemini-pro-api-with-google-apps-script%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2024%2f01%2f25%2fsemantic-search-using-gemini-pro-api-with-google-apps-script%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f01%2f25%2fsemantic-search-using-gemini-pro-api-with-google-apps-script%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f01%2f25%2fsemantic-search-using-gemini-pro-api-with-google-apps-script%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2024/01/22/creating-dining-reservation-system-using-google-apps-script/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2024/01/22/creating-dining-reservation-system-using-google-apps-script/">Creating Dining Reservation System using Google Apps Script</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://tanaikech.github.io/2024/01/25/updated-gas-library-utlapp/">Updated: GAS Library - UtlApp</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://tanaikech.github.io/2024/01/25/updated-gas-library-utlapp/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>






<script src="https://tanaikech.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

