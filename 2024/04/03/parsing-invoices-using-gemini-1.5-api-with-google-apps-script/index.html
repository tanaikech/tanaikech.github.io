<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Parsing Invoices using Gemini 1.5 API with Google Apps Script &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/tanaikech" rel="me" target="_blank"><i class="fa-brands fa-square-x-twitter fa-fw"></i>X</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Parsing Invoices using Gemini 1.5 API with Google Apps Script</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>03 Apr 2024, 11:59</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gemini">Gemini</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/ai">AI</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/llm">LLM</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/165a6a76244a81312f9d398e88c4730d">Gists</a></p>
<p><img src="https://tanaikech.github.io/image-storage/20240403a/fig1.png" alt=""></p>
<h1 id="abstract">Abstract</h1>
<p>This report explores using Gemini, a new AI model, to parse invoices in Gmail attachments. Traditional text searching proved unreliable due to invoice format variations. Gemini&rsquo;s capabilities can potentially overcome this inconsistency and improve invoice data extraction.</p>
<h1 id="introduction">Introduction</h1>
<p>After Gemini, a large language model from Google AI, has been released, it has the potential to be used for modifying various situations, including information extraction from documents. In my specific case, I work with invoices in PDF format. Until now, I relied on the direct search by a Google Apps Script to achieve this task. The script&rsquo;s process involved:</p>
<ol>
<li>Converting each invoice PDF file into a temporary Google Doc.</li>
<li>Utilizing text searching within the Google Doc to extract required values.</li>
<li>Deleting the temporary Google Doc after successful extraction.</li>
</ol>
<p>However, this approach proved unreliable due to variations in the invoice formats of each invoice. The text-searching method often failed to capture the required values consistently across different invoice layouts. This inconsistency led me to believe that Gemini&rsquo;s capabilities could be a valuable asset for invoice parsing.</p>
<p>In this report, I aim to introduce a method for parsing various invoice types and retrieving the required values using Gemini. Here, I chose to leverage Google Apps Script for this project because the invoices are received as email attachments in Gmail. Google Apps Script provides a convenient way to access and process these PDF files directly within the Gmail environment.</p>
<h1 id="usage">Usage</h1>
<p>In order to test this script, please do the following steps.</p>
<h2 id="1-create-an-api-key">1. Create an API key</h2>
<p>Please access <a href="https://makersuite.google.com/app/apikey">https://makersuite.google.com/app/apikey</a> and create your API key. At that time, please enable Generative Language API at the API console. This API key is used for this sample script.</p>
<p>This official document can be also seen. <a href="https://ai.google.dev/">Ref</a>.</p>
<h2 id="2-create-a-google-apps-script-project">2. Create a Google Apps Script project</h2>
<p>In this report, Google Apps Script is used. Of course, the method introducing this report can be also used in other languages.</p>
<p>Please create a standalone Google Apps Script project. Of course, this script can be also used with the container-bound script.</p>
<p>And, please open the script editor of the Google Apps Script project.</p>
<h3 id="important">IMPORTANT</h3>
<p><strong>This script uses a Google Apps Script library for converting PDF data to image data. So, please install <a href="https://github.com/tanaikech/PDFApp">PDFApp</a>. I created this library.</strong></p>
<h2 id="3a-base-script">3A. Base script</h2>
<p>This is the base script as Class InvoiceApp. This is used from a work function. In this script, the function calling is not used. Because when I created this script, Gemini 1.5 API couldn&rsquo;t use the function calling.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Parsing invoice with Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InvoiceApp</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Object} object Object using this library.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> {}) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;models/gemini-1.5-pro-latest&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;v1beta&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://generativelanguage.googleapis.com&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">apiKey</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">authorization</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`Bearer </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">token</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">ScriptApp</span>.<span style="color:#a6e22e">getOAuthToken</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>,
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">retry</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">folderId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">folderId</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;root&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Main method.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns {Promise} Response from API is returned as Promise object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">blob</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Please set the PDF blob of invoice on Google Drive.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blob</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">blob</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`--- Converting PDF blob to PNG images and uploading images to Gemini.`</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">uploadFileByBlob_</span>(<span style="color:#a6e22e">blob</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--- Processing Gemini using the uploaded images.`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Create a table from the given image of the invoice as a JSON object.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`The giving image is the invoice.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Return a created table as a JSON object.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`No descriptions and explanations. Return only raw JSON object without markdown. No markdown format.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`The required properties in JSON object are as follows.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">``</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`[Properties in JSON object]`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceTitle&#34;: &#34;title of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceDate&#34;: &#34;date of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceNumber&#34;: &#34;number of the invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceDestinationName&#34;: &#34;Name of destination of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceDestinationAddress&#34;: &#34;address of the destination of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;totalCost&#34;: &#34;total cost of all costs&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;table&#34;: &#34;Table of invoice. This is a 2-dimensional array. Add the first header row to the table in the 2-dimensional array.&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">``</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`[Format of 2-dimensional array of &#34;table&#34;]`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;title or description of item&#34;, &#34;number of items&#34;, &#34;unit cost&#34;, &#34;total cost&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">``</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`If the requirement information is not found, set &#34;no value&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Return only raw JSON object without markdown. No markdown format. No markcodn tags.`</span>,
</span></span><span style="display:flex;"><span>    ].<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#34;\n&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">doGemini_</span>({ <span style="color:#a6e22e">q</span>, <span style="color:#a6e22e">obj</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--- Deleting the uploaded images from Gemini.`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">forEach</span>(({ <span style="color:#a6e22e">name</span> }) =&gt; <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deleteFile_</span>(<span style="color:#a6e22e">name</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--- Done.`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Upload image files to Gemini.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Blob} Blob PDF blob of invoice on Google Drive.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns {Promise} An array including uri, name, mimeType
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">uploadFileByBlob_</span>(<span style="color:#a6e22e">blob</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">blob</span>.<span style="color:#a6e22e">getContentType</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PDF</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">`Please set PDF blob. The mimeType of this blob is &#39;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">blob</span>.<span style="color:#a6e22e">getContentType</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;`</span>
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageBlobs</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">PDFApp</span>.<span style="color:#a6e22e">setPDFBlob</span>(<span style="color:#a6e22e">blob</span>)
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">convertPDFToPng</span>()
</span></span><span style="display:flex;"><span>      .<span style="color:#66d9ef">catch</span>((<span style="color:#a6e22e">err</span>) =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ar</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/upload/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/files?uploadType=multipart`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">blob</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">imageBlobs</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">metadata</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">displayName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blob</span>.<span style="color:#a6e22e">getName</span>() } };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metadata</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Utilities</span>.<span style="color:#a6e22e">newBlob</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">metadata</span>),
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blob</span>,
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;post&#34;</span>, <span style="color:#a6e22e">payload</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">payload</span> };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">url</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`&amp;key=</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fetch_</span>({ <span style="color:#a6e22e">url</span>, ...<span style="color:#a6e22e">options</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ar</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">uri</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">uri</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">name</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">mimeType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">mimeType</span>,
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ar</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Parsing invoice of image data by Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Object} object Object including q and fileUri.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns {String|Object} Return parsed invoice data from Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">doGemini_</span>(<span style="color:#a6e22e">object</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">q</span>, <span style="color:#a6e22e">obj</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">text</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">q</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:generateContent`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">contentType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">muteHttpExceptions</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">url</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`?key=</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">uri</span>, <span style="color:#a6e22e">mimeType</span> }) =&gt; ({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fileData</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">fileUri</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">uri</span>, <span style="color:#a6e22e">mimeType</span> },
</span></span><span style="display:flex;"><span>    }));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">contents</span> <span style="color:#f92672">=</span> [{ <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span> }, ...<span style="color:#a6e22e">fileData</span>], <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user&#34;</span> }];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">temp</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">retry</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">retry</span><span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({ <span style="color:#a6e22e">contents</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fetch_</span>({ <span style="color:#a6e22e">url</span>, ...<span style="color:#a6e22e">options</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getResponseCode</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">500</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">retry</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Retry by the status code 500.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Utilities</span>.<span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">3000</span>); <span style="color:#75715e">// wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">doGemini_</span>(<span style="color:#a6e22e">object</span>);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getResponseCode</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">candidates</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">candidates</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">content</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">parts</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">temp</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parts</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">candidates</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">content</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">parts</span>) <span style="color:#f92672">||</span> [];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">parts</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parts</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">text</span>.<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/\`\`\`json\n([\w\s\S]*)\`\`\`/</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">t</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">t</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">trim</span>());
</span></span><span style="display:flex;"><span>          } <span style="color:#66d9ef">catch</span> ({ <span style="color:#a6e22e">stack</span> }) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">stack</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">t</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">trim</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">doGemini_</span>(<span style="color:#a6e22e">object</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;No parts[0].text.&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;No parts[0].text.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#a6e22e">parts</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">temp</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#a6e22e">parts</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">result</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">retry</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;No values. Please try it again.&#34;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Delete file from Gemini.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {String} name Name of file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deleteFile_</span>(<span style="color:#a6e22e">name</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#a6e22e">muteHttpExceptions</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">url</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`?key=</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fetch_</span>({ <span style="color:#a6e22e">url</span>, ...<span style="color:#a6e22e">options</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * Request Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Object} obj Object for using UrlFetchApp.fetchAll.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns {UrlFetchApp.HTTPResponse} Response from API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fetch_</span>(<span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">muteHttpExceptions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UrlFetchApp</span>.<span style="color:#a6e22e">fetchAll</span>([<span style="color:#a6e22e">obj</span>])[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getResponseCode</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3b-base-script">3B. Base script</h2>
<p>This is the base script as Class InvoiceApp. This is used from a work function.</p>
<p>In this script, the function calling is used. In the current stage, Gemini 1.5 API can use the function calling. When the function calling is used, the output format can be easily controlled. <a href="https://medium.com/@tanaike/specifying-output-types-for-gemini-api-with-google-apps-script-c2f6a753c8d7">Ref</a></p>
<p>You can use one of the scripts &ldquo;3A. Base script&rdquo; and &ldquo;3B. Base script&rdquo;.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Parsing invoice with Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * In this script, the function calling is used. In the current stage, Gemini 1.5 API can use the function calling. When the function calling is used, the output format can be easily controlled.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ref: https://medium.com/@tanaike/specifying-output-types-for-gemini-api-with-google-apps-script-c2f6a753c8d7
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InvoiceApp</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {Object} object Object using this library.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> {}) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;models/gemini-1.5-pro-latest&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;v1beta&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://generativelanguage.googleapis.com&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">:</span> { <span style="color:#a6e22e">authorization</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`Bearer </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">token</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">ScriptApp</span>.<span style="color:#a6e22e">getOAuthToken</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">`</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">retry</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">folderId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">folderId</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#34;root&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">functions</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">params_</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">customType_object</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Output type is JSON object type. When the output type is object type, this is used. No descriptions and explanations.&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">parameters</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OBJECT&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">items</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;OBJECT&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;Output type is JSON object type. When the output type is object type, this is used. No descriptions and explanations.&#34;</span>,
</span></span><span style="display:flex;"><span>              },
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">required</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;items&#34;</span>],
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">customType_object</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">e</span>) =&gt; <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">items</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * Main method.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @returns {Promise} Response from API is returned as Promise object.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">blob</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#34;Please set the PDF blob of invoice on Google Drive.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blob</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">object</span>.<span style="color:#a6e22e">blob</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--- Converting PDF blob to PNG images and uploading images to Gemini.`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">uploadFileByBlob_</span>(<span style="color:#a6e22e">blob</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--- Processing Gemini using the uploaded images.`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">q</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Create a table from the given image of the invoice as a JSON object.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`The giving image is the invoice.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Return a created table as a JSON object.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`No descriptions and explanations. Return only raw JSON object without markdown. No markdown format.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`The required properties in JSON object are as follows.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">``</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`[Properties in JSON object]`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceTitle&#34;: &#34;title of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceDate&#34;: &#34;date of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceNumber&#34;: &#34;number of the invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceDestinationName&#34;: &#34;Name of destination of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;invoiceDestinationAddress&#34;: &#34;address of the destination of invoice&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;totalCost&#34;: &#34;total cost of all costs&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;table&#34;: &#34;Table of invoice. This is a 2-dimensional array. Add the first header row to the table in the 2-dimensional array.&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">``</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`[Format of 2-dimensional array of &#34;table&#34;]`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`&#34;title or description of item&#34;, &#34;number of items&#34;, &#34;unit cost&#34;, &#34;total cost&#34;`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">``</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`If the requirement information is not found, set &#34;no value&#34;.`</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`Return only raw JSON object without markdown. No markdown format. No markcodn tags.`</span>,
</span></span><span style="display:flex;"><span>    ].<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#34;\n&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">doGemini_</span>({ <span style="color:#a6e22e">q</span>, <span style="color:#a6e22e">obj</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--- Deleting the uploaded images from Gemini.`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">forEach</span>(({ <span style="color:#a6e22e">name</span> }) =&gt; <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">deleteFile_</span>(<span style="color:#a6e22e">name</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">`--- Done.`</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * Upload image files to Gemini.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @param {Blob} Blob PDF blob of invoice on Google Drive.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @returns {Promise} An array including uri, name, mimeType 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">uploadFileByBlob_</span>(<span style="color:#a6e22e">blob</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">blob</span>.<span style="color:#a6e22e">getContentType</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PDF</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Please set PDF blob. The mimeType of this blob is &#39;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">blob</span>.<span style="color:#a6e22e">getContentType</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;`</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imageBlobs</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">PDFApp</span>.<span style="color:#a6e22e">setPDFBlob</span>(<span style="color:#a6e22e">blob</span>).<span style="color:#a6e22e">convertPDFToPng</span>().<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ar</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/upload/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/files?uploadType=multipart`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">blob</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">imageBlobs</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">metadata</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">displayName</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blob</span>.<span style="color:#a6e22e">getName</span>() } };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">metadata</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Utilities</span>.<span style="color:#a6e22e">newBlob</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">metadata</span>), <span style="color:#e6db74">&#34;application/json&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">blob</span>,
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;post&#34;</span>, <span style="color:#a6e22e">payload</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">payload</span> };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">url</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`&amp;key=</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fetch_</span>({ <span style="color:#a6e22e">url</span>, ...<span style="color:#a6e22e">options</span> });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">o</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">ar</span>.<span style="color:#a6e22e">push</span>({ <span style="color:#a6e22e">uri</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">uri</span>, <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">mimeType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">mimeType</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ar</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * Parsing invoice of image data by Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @param {Object} object Object including q and fileUri.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @returns {String|Object} Return parsed invoice data from Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">doGemini_</span>(<span style="color:#a6e22e">object</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">q</span>, <span style="color:#a6e22e">obj</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">object</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">function_declarations</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">keys</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">functions</span>).<span style="color:#a6e22e">flatMap</span>((<span style="color:#a6e22e">k</span>) =&gt; <span style="color:#a6e22e">k</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;params_&#34;</span> <span style="color:#f92672">?</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">k</span>, <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">functions</span>.<span style="color:#a6e22e">params_</span>[<span style="color:#a6e22e">k</span>].<span style="color:#a6e22e">description</span>, <span style="color:#a6e22e">parameters</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">functions</span>.<span style="color:#a6e22e">params_</span>[<span style="color:#a6e22e">k</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">parameters</span>, } <span style="color:#f92672">:</span> []);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">text</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">q</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">model</span><span style="color:#e6db74">}</span><span style="color:#e6db74">:generateContent`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">contentType</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;application/json&#34;</span>, <span style="color:#a6e22e">muteHttpExceptions</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">url</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`?key=</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">map</span>(({ <span style="color:#a6e22e">uri</span>, <span style="color:#a6e22e">mimeType</span> }) =&gt; ({ <span style="color:#a6e22e">fileData</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">fileUri</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">uri</span>, <span style="color:#a6e22e">mimeType</span> } }))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">contents</span> <span style="color:#f92672">=</span> [{ <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">text</span> }, ...<span style="color:#a6e22e">fileData</span>], <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;user&#34;</span> }];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">temp</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">check</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">retry</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">retry</span><span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({ <span style="color:#a6e22e">contents</span>, <span style="color:#a6e22e">tools</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">function_declarations</span> }] });
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fetch_</span>({ <span style="color:#a6e22e">url</span>, ...<span style="color:#a6e22e">options</span> });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getResponseCode</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">500</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">retry</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Retry by the status code 500.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Utilities</span>.<span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">3000</span>); <span style="color:#75715e">// wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">doGemini_</span>(<span style="color:#a6e22e">object</span>);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getResponseCode</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">candidates</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">parse</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">candidates</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">content</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">parts</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">temp</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parts</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">candidates</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">candidates</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">?</span>.<span style="color:#a6e22e">content</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">parts</span>) <span style="color:#f92672">||</span> [];
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">check</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parts</span>.<span style="color:#a6e22e">find</span>((<span style="color:#a6e22e">o</span>) =&gt; <span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">hasOwnProperty</span>(<span style="color:#e6db74">&#34;functionCall&#34;</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">check</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">contents</span>.<span style="color:#a6e22e">push</span>({ <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">parts</span>.<span style="color:#a6e22e">slice</span>(), <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;model&#34;</span> });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">functionName</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">check</span>.<span style="color:#a6e22e">functionCall</span>.<span style="color:#a6e22e">name</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res2</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">functions</span>[<span style="color:#a6e22e">functionName</span>](
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">check</span>.<span style="color:#a6e22e">functionCall</span>.<span style="color:#a6e22e">args</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">/^customType_.*/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">functionName</span>)) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res2</span>.<span style="color:#a6e22e">items</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">res2</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">contents</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">parts</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">functionResponse</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">functionName</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">response</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">functionName</span>, <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">res2</span> },
</span></span><span style="display:flex;"><span>              },
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">role</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">parts</span>.<span style="color:#a6e22e">push</span>({ <span style="color:#a6e22e">functionResponse</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">res2</span> });
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">temp</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#a6e22e">parts</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">check</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">result</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">retry</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">output</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">!</span><span style="color:#a6e22e">output</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">output</span>.<span style="color:#a6e22e">finishReason</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>        [<span style="color:#e6db74">&#34;OTHER&#34;</span>, <span style="color:#e6db74">&#34;RECITATION&#34;</span>].<span style="color:#a6e22e">includes</span>(<span style="color:#a6e22e">output</span>.<span style="color:#a6e22e">finishReason</span>))
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;No values.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">output</span>.<span style="color:#a6e22e">text</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;\n&#34;</span>).<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">e</span>) =&gt; <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">trim</span>());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * Delete file from Gemini.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @param {String} name Name of file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @return {void}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deleteFile_</span>(<span style="color:#a6e22e">name</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">baseUrl</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">version</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">name</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">options</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;delete&#34;</span>, <span style="color:#a6e22e">muteHttpExceptions</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">url</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">`?key=</span><span style="color:#e6db74">${</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">apiKey</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">headers</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">headers</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">fetch_</span>({ <span style="color:#a6e22e">url</span>, ...<span style="color:#a6e22e">options</span> });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * ### Description
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * Request Gemini API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @param {Object} obj Object for using UrlFetchApp.fetchAll.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  * @returns {UrlFetchApp.HTTPResponse} Response from API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fetch_</span>(<span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">obj</span>.<span style="color:#a6e22e">muteHttpExceptions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">UrlFetchApp</span>.<span style="color:#a6e22e">fetchAll</span>([<span style="color:#a6e22e">obj</span>])[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getResponseCode</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">200</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">getContentText</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="4-sample-script-1">4. Sample script 1</h2>
<p>In this sample, the PDF file of invoice is retrieved from Gmail. And, the PDF invoice is parsed by Gemini 1.5 API.</p>
<p>This is a simple script. So, please modify this to your actual situation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sample1</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>; <span style="color:#75715e">// Please set your API key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Reading PDF file from Gmail and save it in Google Drive.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">threads</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GmailApp</span>.<span style="color:#a6e22e">search</span>(<span style="color:#e6db74">&#39;subject:&#34;invoice&#34;&#39;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">threads</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;No threads.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blob</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">threads</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">pop</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">getMessages</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">pop</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">getAttachments</span>()[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setContentTypeFromExtension</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">blob</span>.<span style="color:#a6e22e">getContentType</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">MimeType</span>.<span style="color:#a6e22e">PDF</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;This attachment is not PDF.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pdfFile</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">DriveApp</span>.<span style="color:#a6e22e">createFile</span>(<span style="color:#a6e22e">blob</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Parsing invoice of PDF file and retrieve values.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ip</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">InvoiceApp</span>({ <span style="color:#a6e22e">apiKey</span>, <span style="color:#a6e22e">blob</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">pdfFile</span>.<span style="color:#a6e22e">getBlob</span>() });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ip</span>.<span style="color:#a6e22e">run</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;object&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;--- Valid values.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">res</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do something.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;--- Invalid values.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">res</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// pdfFile.setTrashed(true); // If you want to remove the PDF file, please use this line.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="5-sample-script-2">5. Sample script 2</h2>
<p>In this sample, the PDF invoice file on Google Drive is directly used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">sample2</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>; <span style="color:#75715e">// Please set your API key.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fileId</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;###&#34;</span>; <span style="color:#75715e">// File ID of PDF file of invoice file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Parsing invoice of PDF file and retrieve values.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ip</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">InvoiceApp</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">apiKey</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">blob</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">DriveApp</span>.<span style="color:#a6e22e">getFileById</span>(<span style="color:#a6e22e">fileId</span>).<span style="color:#a6e22e">getBlob</span>(),
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">ip</span>.<span style="color:#a6e22e">run</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;object&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;--- Valid values.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(<span style="color:#a6e22e">res</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do something.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;--- Invalid values.&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">res</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="testing">Testing</h2>
<p>This is a sample invoice. <a href="https://create.microsoft.com/en-us/template/service-invoice-(simple-lines-design-worksheet)-c10068f0-7a64-423b-abad-dced024877b0">This sample</a> is from <a href="https://create.microsoft.com/en-us/templates/invoices">Invoice design templates of Microsoft</a>.</p>
<p><img src="https://tanaikech.github.io/image-storage/20240403a/fig2.png" alt=""></p>
<p>When the above sample invoice is used, the following result is obtained.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceTitle&#34;</span>: <span style="color:#e6db74">&#34;Invoice&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceDate&#34;</span>: <span style="color:#e6db74">&#34;January 1, 2024&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceNumber&#34;</span>: <span style="color:#e6db74">&#34;100&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceDestinationName&#34;</span>: <span style="color:#e6db74">&#34;Maria Sullivan\nThe Palm Tree Nursery\n987 6th Ave\nSanta Fe, NM 11121&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceDestinationAddress&#34;</span>: <span style="color:#e6db74">&#34;no value&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;totalCost&#34;</span>: <span style="color:#e6db74">&#34;$192.50&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;table&#34;</span>: [
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;Qty&#34;</span>, <span style="color:#e6db74">&#34;Description&#34;</span>, <span style="color:#e6db74">&#34;Unit Price&#34;</span>, <span style="color:#e6db74">&#34;Line Total&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;20.00&#34;</span>, <span style="color:#e6db74">&#34;Areca palm&#34;</span>, <span style="color:#e6db74">&#34;$2.50&#34;</span>, <span style="color:#e6db74">&#34;$50.00&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;35.00&#34;</span>, <span style="color:#e6db74">&#34;Majesty palm&#34;</span>, <span style="color:#e6db74">&#34;$3.00&#34;</span>, <span style="color:#e6db74">&#34;$105.00&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;15.00&#34;</span>, <span style="color:#e6db74">&#34;Bismarck palm&#34;</span>, <span style="color:#e6db74">&#34;$2.50&#34;</span>, <span style="color:#e6db74">&#34;$37.50&#34;</span>]
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Another sample is as follows. <a href="https://create.microsoft.com/en-us/template/service-invoice-with-tax-calculations-9330a1fe-20ae-4590-ac01-54c53ed1f3ba">This sample</a> is from <a href="https://create.microsoft.com/en-us/templates/invoices">Invoice design templates of Microsoft</a>.</p>
<p><img src="https://tanaikech.github.io/image-storage/20240403a/fig3.png" alt=""></p>
<p>When the above sample invoice is used, the following result is obtained.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceTitle&#34;</span>: <span style="color:#e6db74">&#34;INVOICE&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceDate&#34;</span>: <span style="color:#e6db74">&#34;April 1, 2024&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceNumber&#34;</span>: <span style="color:#e6db74">&#34;100&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceDestinationName&#34;</span>: <span style="color:#e6db74">&#34;Nazar Neili&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;invoiceDestinationAddress&#34;</span>: <span style="color:#e6db74">&#34;Downtown Pets\n123 South Street\nManhattan, NY 15161&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;totalCost&#34;</span>: <span style="color:#e6db74">&#34;$4350&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;table&#34;</span>: [
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;DESCRIPTION&#34;</span>, <span style="color:#e6db74">&#34;HOURS&#34;</span>, <span style="color:#e6db74">&#34;RATE&#34;</span>, <span style="color:#e6db74">&#34;AMOUNT&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;Pour cement foundation&#34;</span>, <span style="color:#e6db74">&#34;4.00&#34;</span>, <span style="color:#e6db74">&#34;$150.00&#34;</span>, <span style="color:#e6db74">&#34;$600&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;Framing and drywall&#34;</span>, <span style="color:#e6db74">&#34;16.00&#34;</span>, <span style="color:#e6db74">&#34;$190.00&#34;</span>, <span style="color:#e6db74">&#34;$3040&#34;</span>],
</span></span><span style="display:flex;"><span>    [<span style="color:#e6db74">&#34;Tiling and flooring install&#34;</span>, <span style="color:#e6db74">&#34;9.00&#34;</span>, <span style="color:#e6db74">&#34;$150.00&#34;</span>, <span style="color:#e6db74">&#34;$1350&#34;</span>]
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="note">Note</h1>
<ul>
<li>When this method is used, not only the invoices but also the receipts can be parsed.</li>
</ul>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2024%2f04%2f03%2fparsing-invoices-using-gemini-1.5-api-with-google-apps-script%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2024%2f04%2f03%2fparsing-invoices-using-gemini-1.5-api-with-google-apps-script%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f04%2f03%2fparsing-invoices-using-gemini-1.5-api-with-google-apps-script%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2024%2f04%2f03%2fparsing-invoices-using-gemini-1.5-api-with-google-apps-script%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f04%2f03%2fparsing-invoices-using-gemini-1.5-api-with-google-apps-script%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2024%2f04%2f03%2fparsing-invoices-using-gemini-1.5-api-with-google-apps-script%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2024/04/02/convert-soft-breaks-to-hard-breaks-on-google-documents-using-google-apps-script/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2024/04/02/convert-soft-breaks-to-hard-breaks-on-google-documents-using-google-apps-script/">Convert Soft Breaks to Hard Breaks on Google Documents using Google Apps Script</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://tanaikech.github.io/2024/04/10/identifying-colored-cell-regions-in-google-sheets-with-google-apps-script/">Identifying Colored Cell Regions in Google Sheets with Google Apps Script</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://tanaikech.github.io/2024/04/10/identifying-colored-cell-regions-in-google-sheets-with-google-apps-script/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>






<script src="https://tanaikech.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

