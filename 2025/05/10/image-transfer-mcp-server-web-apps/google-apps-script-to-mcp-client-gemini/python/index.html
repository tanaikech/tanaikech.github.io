<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="google-site-verification" content="1BvDMY90ui0jRLHkrpqdQ_x62h5VNEMuK6mQsDvVQH0" />

  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.98.0" />

  <title>Image Transfer: MCP Server (Web Apps/Google Apps Script) to MCP Client (Gemini/Python) &middot; tanaike</title>

    

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">

  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet" type="text/css">

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/androidstudio.min.css">
  <script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/link/"><i class='fa fa-thumbs-up fa-fw'></i>Links</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/webapps/"><i class='fas fa-toolbox'></i>Web Applications</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/donate/"><i class='fas fa-donate'></i>Donate</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/tanaikech" rel="me" target="_blank"><i class="fab fa-twitter-square fa-fw"></i>X</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" rel="me" target="_blank"><i class="fab fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" rel="me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Image Transfer: MCP Server (Web Apps/Google Apps Script) to MCP Client (Gemini/Python)</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>10 May 2025, 14:06</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>&nbsp;&#47;
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/pythontips">PythonTips</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/python">Python</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/model-context-protocol">Model Context Protocol</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/mcp">MCP</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/gemini">Gemini</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/ai">AI</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/llm">LLM</a>
    
  </div>
  
  

</div>

  <p><a href="https://gist.github.com/tanaikech/8dc35b2e331ec99b0bdbc74b73eab821">Gists</a></p>
<h1 id="abstract">Abstract</h1>
<p>This report details transferring image data via Model Context Protocol (MCP) from Google Apps Script server to a Python/Gemini client, extending capabilities for multimodal applications beyond text.</p>
<h1 id="introduction">Introduction</h1>
<p>Following up on my previous report, &ldquo;Building Model Context Protocol (MCP) Server with Google Apps Script&rdquo; (<a href="https://medium.com/google-cloud/building-model-context-protocol-mcp-server-with-google-apps-script-9ff1fe58653c">Ref</a>), which detailed the transfer of text data between the MCP server and client, this new report focuses on extending the protocol to handle image data. It introduces a practical method for transferring image data efficiently from the Google Apps Script-based MCP server to an MCP client. In this implementation, the MCP client was built using Python and integrated with the Gemini model, allowing for the processing and utilization of the transferred image data alongside text, thereby enabling more complex, multimodal applications within the MCP framework.</p>
<h1 id="flow">Flow</h1>
<p>The flow of this approach is very simple. The MCP client communicates to the MCP server using the HTTP request as follows.</p>
<p><img src="https://tanaikech.github.io/image-storage/20250510a/fig1.png" alt=""></p>
<h1 id="usage">Usage</h1>
<h2 id="1-create-an-mcp-server">1. Create an MCP server</h2>
<p>About the steps for deploying the MCP server, please read my previous report. <a href="https://medium.com/google-cloud/building-model-context-protocol-mcp-server-with-google-apps-script-9ff1fe58653c">Ref</a></p>
<p>The script in this report is as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This function retrieves an image by searching Google Drive.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This function is run by &#34;tools/call&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * &#34;tools/call&#34;: The function name is required to be the same as the name declared at &#34;tools/list&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_image</span>(<span style="color:#a6e22e">args</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">filename</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">args</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">DriveApp</span>.<span style="color:#a6e22e">searchFiles</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">`title contains &#39;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">filename</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; and mimeType contains &#39;image&#39; and trashed=false`</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">hasNext</span>()) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`Actual filename on Google Drive is </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">getName</span>()<span style="color:#e6db74">}</span><span style="color:#e6db74">.`</span>,
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;image&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">data</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Utilities</span>.<span style="color:#a6e22e">base64Encode</span>(<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">getBlob</span>().<span style="color:#a6e22e">getBytes</span>()),
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">mimeType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">getMimeType</span>(),
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">isError</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;text&#34;</span>, <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`There is no file of &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">filename</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;.`</span> }],
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">isError</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">content</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;text&#34;</span>, <span style="color:#a6e22e">text</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">message</span> }], <span style="color:#a6e22e">isError</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">jsonrpc</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#a6e22e">result</span> };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Please set and modify the following JSON to your situation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * The key is the method from the MCP client.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * The value is the object for returning to the MCP client.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ID is automatically set in the script.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * The specification of this can be seen in the official document.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Ref: https://modelcontextprotocol.io/specification/2025-03-26
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getserverResponse_</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Response to &#34;initialize&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">initialize</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">jsonrpc</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2.0&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">result</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">protocolVersion</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2024-11-05&#34;</span>, <span style="color:#75715e">// or &#34;2025-03-26&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">capabilities</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">experimental</span><span style="color:#f92672">:</span> {},
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">prompts</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">listChanged</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">resources</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">subscribe</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">listChanged</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">tools</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">listChanged</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">serverInfo</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sample server from MCPApp&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">version</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Response to &#34;tools/list&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;tools/list&#34;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">jsonrpc</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2.0&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">result</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tools</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>          {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;get_image&#34;</span>, <span style="color:#75715e">// &lt;--- It is required to create a function of the same name as this.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Get image from Google Drive.&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">inputSchema</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">filename</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                  <span style="color:#a6e22e">description</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Get image of this filename from Google Drive.&#34;</span>,
</span></span><span style="display:flex;"><span>                  <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>              },
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">required</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#34;filename&#34;</span>],
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * &#34;tools/call&#34;: The function name is required to be the same as the name declared at &#34;tools/list&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * &#34;resources/read&#34;: The function name is required to be the same as the uri declared at &#34;resources/list&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getFunctions_</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#e6db74">&#34;tools/call&#34;</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">get_image</span> } };
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This function is automatically run when the MCP client accesses Web Apps.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">doPost</span>(<span style="color:#a6e22e">eventObject</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">object</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">eventObject</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">serverResponse</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getserverResponse_</span>(),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">functions</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getFunctions_</span>(),
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">MCPApp</span>.<span style="color:#a6e22e">mcpApp</span>({ <span style="color:#a6e22e">accessKey</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;sample&#34;</span> }).<span style="color:#a6e22e">server</span>(<span style="color:#a6e22e">object</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In this sample, the following data is transferred to the MCP server.</p>
<pre tabindex="0"><code>{
  content: [
    { type: &#34;text&#34;, text: `Actual filename on Google Drive is ${file.getName()}.` },
    {
      type: &#34;image&#34;,
      data: Utilities.base64Encode(file.getBlob().getBytes()),
      mimeType: file.getMimeType(),
    }
  ],
  isError: false
}
</code></pre><p>Both the text data and the image data are transferred. The image data is transferred as base64 data. Also. in this script, the access key of <code>sample</code> is used. Please copy your Web Apps URL. This URL is used for the MCP client.</p>
<h2 id="2-create-an-mcp-client">2. Create an MCP client</h2>
<p>In this report, Gemini is used with Python. The original script is from the official page. <a href="https://ai.google.dev/gemini-api/docs/function-calling?example=meeting#use_model_context_protocol_mcp">Ref</a> I modified this script for transferring the image.</p>
<p>Before you run this script, please set your API key. And, replace <code>https://script.google.com/macros/s/###/exec?accessKey=sample</code> with your Web Apps URL.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> io
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> google <span style="color:#f92672">import</span> genai
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> google.genai <span style="color:#f92672">import</span> types
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> mcp <span style="color:#f92672">import</span> ClientSession, StdioServerParameters
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> mcp.client.stdio <span style="color:#f92672">import</span> stdio_client
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>client <span style="color:#f92672">=</span> genai<span style="color:#f92672">.</span>Client(api_key<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;GEMINI_API_KEY&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create server parameters for stdio connection</span>
</span></span><span style="display:flex;"><span>server_params <span style="color:#f92672">=</span> StdioServerParameters(
</span></span><span style="display:flex;"><span>    command<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;npx&#34;</span>,  <span style="color:#75715e"># Executable</span>
</span></span><span style="display:flex;"><span>    args<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;mcp-remote&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;https://script.google.com/macros/s/###/exec?accessKey=sample&#34;</span>,
</span></span><span style="display:flex;"><span>    ],  <span style="color:#75715e"># MCP Server built by Web Apps with Google Apps Script</span>
</span></span><span style="display:flex;"><span>    env<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,  <span style="color:#75715e"># Optional environment variables</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> stdio_client(server_params) <span style="color:#66d9ef">as</span> (read, write):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> ClientSession(read, write) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Prompt to get the weather for the current day in London.</span>
</span></span><span style="display:flex;"><span>            prompt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Get an image of &#34;CherryBlossom&#34; from Google Drive.&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Initialize the connection between client and server</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>initialize()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get tools from MCP session and convert to Gemini Tool objects</span>
</span></span><span style="display:flex;"><span>            mcp_tools <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>list_tools()
</span></span><span style="display:flex;"><span>            tools <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>                types<span style="color:#f92672">.</span>Tool(
</span></span><span style="display:flex;"><span>                    function_declarations<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>                        {
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;name&#34;</span>: tool<span style="color:#f92672">.</span>name,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;description&#34;</span>: tool<span style="color:#f92672">.</span>description,
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;parameters&#34;</span>: {
</span></span><span style="display:flex;"><span>                                k: v
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> tool<span style="color:#f92672">.</span>inputSchema<span style="color:#f92672">.</span>items()
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">if</span> k <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;additionalProperties&#34;</span>, <span style="color:#e6db74">&#34;$schema&#34;</span>]
</span></span><span style="display:flex;"><span>                            },
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    ]
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> tool <span style="color:#f92672">in</span> mcp_tools<span style="color:#f92672">.</span>tools
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Send request to the model with MCP function declarations</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>generate_content(
</span></span><span style="display:flex;"><span>                model<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gemini-2.0-flash&#34;</span>,
</span></span><span style="display:flex;"><span>                contents<span style="color:#f92672">=</span>prompt,
</span></span><span style="display:flex;"><span>                config<span style="color:#f92672">=</span>types<span style="color:#f92672">.</span>GenerateContentConfig(
</span></span><span style="display:flex;"><span>                    temperature<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>                    tools<span style="color:#f92672">=</span>tools,
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Check for a function call</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>candidates[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>content<span style="color:#f92672">.</span>parts[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>function_call:
</span></span><span style="display:flex;"><span>                function_call <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>candidates[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>content<span style="color:#f92672">.</span>parts[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>function_call
</span></span><span style="display:flex;"><span>                print(function_call)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Call the MCP server with the predicted tool</span>
</span></span><span style="display:flex;"><span>                result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> session<span style="color:#f92672">.</span>call_tool(
</span></span><span style="display:flex;"><span>                    function_call<span style="color:#f92672">.</span>name, arguments<span style="color:#f92672">=</span>function_call<span style="color:#f92672">.</span>args
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> e <span style="color:#f92672">in</span> result<span style="color:#f92672">.</span>content:
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;text&#34;</span>:
</span></span><span style="display:flex;"><span>                        print(e<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> e<span style="color:#f92672">.</span>type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;image&#34;</span>:
</span></span><span style="display:flex;"><span>                        image_data <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64decode(e<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>                        image <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(io<span style="color:#f92672">.</span>BytesIO(image_data))
</span></span><span style="display:flex;"><span>                        image<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;No function call found in the response.&#34;</span>)
</span></span><span style="display:flex;"><span>                print(response<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start the asyncio event loop and run the main function</span>
</span></span><span style="display:flex;"><span>asyncio<span style="color:#f92672">.</span>run(run())
</span></span></code></pre></div><h2 id="3-testing">3. Testing</h2>
<p>When this MCP client is run, the following result is obtained. You can see both the text data and the image data are retrieved.</p>
<p><img src="https://tanaikech.github.io/image-storage/20250510a/fig2.jpg" alt=""></p>
<p>This sample image was generated by Gemini for testing in advance.</p>
<h1 id="summary">Summary</h1>
<ul>
<li>This report details transferring image data via MCP from a Google Apps Script server to a Python/Gemini client.</li>
<li>It extends the Model Context Protocol to handle image data for multimodal applications.</li>
<li>The server uses Google Apps Script to retrieve images from Google Drive and encode them in base64.</li>
<li>The Python client with Gemini interacts with the server and processes the received base64 image data.</li>
<li>This setup enables processing image data alongside text within the MCP framework using Gemini.</li>
</ul>

  
  <h4><i class="fas fa-share-alt" aria-hidden="true"></i>&nbsp;Share!</h4>
<ul class="share-buttons">
	<li><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ftanaikech.github.io%2f2025%2f05%2f10%2fimage-transfer-mcp-server-web-apps%2fgoogle-apps-script-to-mcp-client-gemini%2fpython%2f" target="_blank" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span class="sr-only">Share on Facebook</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://twitter.com/intent/tweet?source=https%3a%2f%2ftanaikech.github.io%2f2025%2f05%2f10%2fimage-transfer-mcp-server-web-apps%2fgoogle-apps-script-to-mcp-client-gemini%2fpython%2f" target="_blank" title="Tweet"><i class="fab fa-twitter" aria-hidden="true"></i><span class="sr-only">Tweet</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="https://plus.google.com/share?url=https%3a%2f%2ftanaikech.github.io%2f2025%2f05%2f10%2fimage-transfer-mcp-server-web-apps%2fgoogle-apps-script-to-mcp-client-gemini%2fpython%2f" target="_blank" title="Share on Google+"><i class="fab fa-google-plus" aria-hidden="true"></i><span class="sr-only">Share on Google+</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.tumblr.com/share?v=3&u=https%3a%2f%2ftanaikech.github.io%2f2025%2f05%2f10%2fimage-transfer-mcp-server-web-apps%2fgoogle-apps-script-to-mcp-client-gemini%2fpython%2f" target="_blank" title="Post to Tumblr"><i class="fab fa-tumblr" aria-hidden="true"></i><span class="sr-only">Post to Tumblr</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2ftanaikech.github.io%2f2025%2f05%2f10%2fimage-transfer-mcp-server-web-apps%2fgoogle-apps-script-to-mcp-client-gemini%2fpython%2f" target="_blank" title="Pin it"><i class="fab fa-pinterest-p" aria-hidden="true"></i><span class="sr-only">Pin it</span></a>
	</li>&nbsp;&nbsp;&nbsp;
	<li><a href="http://www.reddit.com/submit?url=https%3a%2f%2ftanaikech.github.io%2f2025%2f05%2f10%2fimage-transfer-mcp-server-web-apps%2fgoogle-apps-script-to-mcp-client-gemini%2fpython%2f" target="_blank" title="Submit to Reddit"><i class="fab fa-reddit-alien" aria-hidden="true"></i><span class="sr-only">Submit to Reddit</span></a>
	</li>
</ul>


<style>
	ul.share-buttons{
	  list-style: none;
	  padding: 0;
	}

	ul.share-buttons li{
	  display: inline;
	}

	ul.share-buttons .sr-only{
	  position: absolute;
	  clip: rect(1px 1px 1px 1px);
	  clip: rect(1px, 1px, 1px, 1px);
	  padding: 0;
	  border: 0;
	  height: 1px;
	  width: 1px;
	  overflow: hidden;
	}
</style>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2025/05/08/building-model-context-protocol-mcp-server-with-google-apps-script/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2025/05/08/building-model-context-protocol-mcp-server-with-google-apps-script/">Building Model Context Protocol (MCP) Server with Google Apps Script</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
  </div>
</div>


  
  
  
  

  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>
<script src="https://tanaikech.github.io/js/menus.js"></script>






<script async src="https://www.googletagmanager.com/gtag/js?id=G-J3Z6T50WL5"></script>
<script>
  
  if (window.location.hostname != "localhost") {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J3Z6T50WL5');
  }
</script>






<script src="https://tanaikech.github.io/js/math-code.js"></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  


</body>
</html>

