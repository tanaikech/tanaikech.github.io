<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.49.2" />

  <title>Protecting Cells of Spreadsheet that Users Copied from Your Google Drive to User&#39;s Google Drive using Google Apps Script &middot; tanaike</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://tanaikech.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://tanaikech.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://tanaikech.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://tanaikech.github.io/">TANAIKE</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/topics/"><i class='fa fa-folder fa-fw'></i>Topics</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://tanaikech.github.io/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/tanaikech" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/7108653" target="_blank"><i class="fa fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Protecting Cells of Spreadsheet that Users Copied from Your Google Drive to User&#39;s Google Drive using Google Apps Script</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>17 Jul 2019, 08:20</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="https://tanaikech.github.io/topics/gastips">GasTips</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/google-apps-script">Google Apps Script</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/web-apps">Web Apps</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/spreadsheet">Spreadsheet</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://tanaikech.github.io/tags/protect">Protect</a>
    
  </div>
  
  

</div>

  

<p><a href="https://gist.github.com/tanaikech/847ea7e3e27a4a22004faa88d7b4dedb">Gists</a></p>

<p>This is the method for protecting cells of Spreadsheet that users copied from your Google Drive to user&rsquo;s Google Drive using Google Apps Script.</p>

<h2 id="situation">Situation:</h2>

<p>This method supposes the following situation.</p>

<ul>
<li>You want to make users copy a Spreadsheet on your Google Drive to user&rsquo;s Google Drive. - Your Spreadsheet has several protected ranges. - Your Spreadsheet is shared with the user. - User doesn&rsquo;t have own folder shared with you.</li>
<li>You want to protect the ranges of Spreadsheet for the user. Namely, you want to remove the user from the editor of protected ranges.</li>
<li>You want to achieve this using Google Apps Script.</li>
</ul>

<h2 id="issue">Issue:</h2>

<p>In above situation, I think that the following points are the bottleneck.</p>

<ul>
<li>When the Spreadsheet in your Google Drive is copied to user&rsquo;s Google Drive, it is required to be run by the user&rsquo;s account.</li>
<li>When the Spreadsheet is copied to user&rsquo;s Google Drive by user, the owner of protected ranges becomes the user. So the user can edit the protected ranges. And the user cannot remove the user from the editor by the user. - In order to make the user not edit the protected ranges, it is required to change the owner of Spreadsheet, and then, it is required to remove the user from the editor of the protected ranges.</li>
<li><strong>Here, 2 more issues occur.</strong> 1. In order to change the owner of Spreadsheet to you, it is required to be run by the user&rsquo;s account. 2. In order to remove the user from the editor of the protected ranges, it is required to be run by your account which is not the user&rsquo;s account.</li>
</ul>

<p>As the result, in order to achieve above your goal using a script, the script is required to be run by the user and you.</p>

<h2 id="workaround">Workaround:</h2>

<p>In my workaround, using 2 scripts and 2 account, it achieves above goal. The point of this workaround is to using 2 Web Apps. Please think of this as just one of several workarounds. The flow of this workaround is as follows.</p>

<h3 id="flow-of-workaround">Flow of workaround:</h3>

<p>In this workaround, 2 Web Apps of Web Apps &ldquo;A&rdquo; and Web Apps &ldquo;B&rdquo; are used.</p>

<ol>
<li>User accesses to Web Apps &ldquo;A&rdquo; that you deployed.

<ul>
<li><strong>In this case, Web Apps is executed as the user.</strong></li>
</ul></li>
<li>When the Web Apps &ldquo;A&rdquo; is run,

<ol>
<li>Your Spreadsheet is copied from your Google Drive to user&rsquo;s Google Drive.</li>
<li>Owner of copied Spreadsheet is the user. So change the owner from the user to you.</li>
<li>Access to Web Apps &ldquo;B&rdquo; in the script.

<ul>
<li><strong>In this case, Web Apps is executed as you.</strong></li>
</ul></li>
<li>When the Web Apps &ldquo;B&rdquo; is run,

<ol>
<li>The user is removed from the editor of the protected ranges.</li>
</ol></li>
</ol></li>
</ol>

<h2 id="usage-of-scripts">Usage of scripts:</h2>

<h3 id="preparation">Preparation:</h3>

<p>Please create 2 projects of the standalone script type.</p>

<ul>
<li>One is for Web Apps &ldquo;A&rdquo;.</li>
<li>Another is for Web Apps &ldquo;B&rdquo;.</li>
</ul>

<h3 id="standalone-script-for-web-apps-b">Standalone script for Web Apps &ldquo;B&rdquo;:</h3>

<p>At first, please deploy Web Apps &ldquo;B&rdquo;, because the URL of Web Apps &ldquo;B&rdquo; is used at the script of Web Apps &ldquo;A&rdquo;. Please copy the following script and deploy Web Apps as <code>Execute the app as: **Me**</code> and <code>Who has access to the app: **Anyone, even anonymous**</code>. About how to deploy Web Apps, please check <a href="#deploywebapps">here</a>. And please copy the URL of this Web Apps &ldquo;B&rdquo; and paste it to <code>url</code> of the script of Web Apps &ldquo;A&rdquo;.</p>

<h4 id="if-you-want-to-protect-the-protected-ranges-which-have-alrady-installed-in-the-spreadsheet-please-use-the-following-script">If you want to protect the protected ranges which have alrady installed in the Spreadsheet, please use the following script.</h4>

<pre><code class="language-javascript">function doGet(e) {
  var id = e.parameter.id;
  if (id) {
    var owner = Session.getActiveUser().getEmail();
    var ss = SpreadsheetApp.openById(id);
    var protectedRanges = ss.getProtections(
      SpreadsheetApp.ProtectionType.RANGE
    );
    protectedRanges.forEach(function(p) {
      var removes = p.getEditors().filter(function(e) {
        return e.getEmail() != owner;
      });
      p.removeEditors(removes);
    });
  }
  return ContentService.createTextOutput(&quot;Done&quot;);
}
</code></pre>

<h4 id="if-you-want-to-protect-the-ranges-cells-when-the-user-copies-the-spreadsheet-please-use-the-following-script">If you want to protect the ranges (cells) when the user copies the Spreadsheet, please use the following script.</h4>

<pre><code class="language-javascript">function doGet(e) {
  var protectRange = &quot;Sheet1!A1:B5&quot;; // Sample protected range.

  var id = e.parameter.id;
  if (id) {
    var owner = Session.getActiveUser().getEmail();
    var ss = SpreadsheetApp.openById(id);
    var p = ss.getRange(protectRange).protect();
    var removes = p.getEditors().filter(function(e) {
      return e.getEmail() != owner;
    });
    p.removeEditors(removes);
  }
  return ContentService.createTextOutput(&quot;Done&quot;);
}
</code></pre>

<h3 id="standalone-script-for-web-apps-a">Standalone script for Web Apps &ldquo;A&rdquo;:</h3>

<p>Please copy the following script and set the variables of <code>srcSpreadsheetId</code> and <code>url</code>. In this case, <code>url</code> is the URL retrieved at Web Apps &ldquo;B&rdquo;. Then, please deploy Web Apps as <code>Execute the app as: **User accessing the web app**</code> and <code>Who has access to the app: **Anyone**</code>. About how to deploy Web Apps, please check <a href="#deploywebapps">here</a>. And please copy the URL of this Web Apps &ldquo;A&rdquo;. This URL is used for accessing by the user.</p>

<pre><code class="language-javascript">function doGet() {
  var srcSpreadsheetId = &quot;###&quot;; // Please set your source Spreadsheet ID.
  var url = &quot;###&quot;; // Please set the URL of Web Apps B.

  var srcSS = SpreadsheetApp.openById(srcSpreadsheetId);
  var dstSS = srcSS.copy(srcSS.getName());
  var file = DriveApp.getFileById(dstSS.getId()).setOwner(
    srcSS.getOwner().getEmail()
  );
  var res = UrlFetchApp.fetch(url + &quot;?id=&quot; + file.getId(), {
    muteHttpExceptions: true
  }); // Here, run the script of Web Apps &quot;B&quot;.
  return ContentService.createTextOutput(res.getContentText());
}
</code></pre>

<h3 id="run">Run:</h3>

<p>When the user uses above scripts, please make the user access to the URL of Web Apps &ldquo;A&rdquo; using own browser. When the user accesses to Web Apps &ldquo;A&rdquo;, the login screen of Google is displayed. By logging in to Google, the authorization screen is shows. By authorizing it, the script of Web Apps &ldquo;A&rdquo; is run, and Web Apps &ldquo;B&rdquo; is run by the Web Apps &ldquo;A&rdquo;. The authorization is required to do only one time.</p>

<p>When &ldquo;Done&rdquo; is shown in user&rsquo;s browser, the user can see the copied Spreadsheet at the root folder.</p>

<p>By this, your Spreadsheet in your Google Drive is copied to the user&rsquo;s Google Drive, and the owner of Spreadsheet is modified to you, and then, the user is removed from the editor of the protected ranges. So the user get to not be able to edit the protected ranges.</p>

<p><a name="deploywebapps"></a></p>

<h2 id="how-to-deploy-web-apps">How to deploy Web Apps:</h2>

<ol>
<li>On the script editor, Open a dialog box by &ldquo;Publish&rdquo; -&gt; &ldquo;Deploy as web app&rdquo;.</li>
<li>Select <strong>&ldquo;User accessing the web app&rdquo;</strong> or <strong>&ldquo;Me&rdquo;</strong> for &ldquo;Execute the app as:&ldquo;.</li>
<li>Select <strong>&ldquo;Anyone&rdquo;</strong> or <strong>&ldquo;Anyone, even anonymous&rdquo;</strong> for &ldquo;Who has access to the app:&ldquo;.</li>
<li>Click &ldquo;Deploy&rdquo; button as new &ldquo;Project version&rdquo;.</li>
<li>Automatically open a dialog box of &ldquo;Authorization required&rdquo;.

<ol>
<li>Click &ldquo;Review Permissions&rdquo;.</li>
<li>Select own account.</li>
<li>Click &ldquo;Advanced&rdquo; at &ldquo;This app isn&rsquo;t verified&rdquo;.</li>
<li>Click &ldquo;Go to ### project name ###(unsafe)&rdquo;</li>
<li>Click &ldquo;Allow&rdquo; button.</li>
</ol></li>
<li>Copy &ldquo;Current web app URL:&ldquo;.

<ul>
<li>It&rsquo;s like <code>https://script.google.com/macros/s/#####/exec</code>.</li>
</ul></li>
<li>Click &ldquo;OK&rdquo;.</li>
</ol>

<h2 id="important">IMPORTANT:</h2>

<ol>
<li><strong>When you modified the script of Web Apps, please redeploy Web Apps as new version. By this, the latest script is reflected to Web Apps. When the Web Apps is not redeployed even when the script is modified, the latest script is not used. Please be careful this.</strong></li>
<li>Please confirm that the Spreadsheet, that you want to make the user copy, is shared with the user.</li>
</ol>

<h2 id="references">References:</h2>

<ul>
<li><a href="https://developers.google.com/apps-script/guides/web">Web Apps</a></li>
<li><a href="https://github.com/tanaikech/taking-advantage-of-Web-Apps-with-google-apps-script">Taking advantage of Web Apps with Google Apps Script</a></li>
<li><a href="https://developers.google.com/apps-script/reference/spreadsheet/protection">Class Protection</a></li>
</ul>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://tanaikech.github.io/2019/07/05/linking-cloud-platform-project-to-google-apps-script-project/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://tanaikech.github.io/2019/07/05/linking-cloud-platform-project-to-google-apps-script-project/">Linking Cloud Platform Project to Google Apps Script Project</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://tanaikech.github.io/2019/07/18/go-library---go-gdoctableapp/">Go Library - go-gdoctableapp</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://tanaikech.github.io/2019/07/18/go-library---go-gdoctableapp/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="https://tanaikech.github.io/js/ui.js"></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
    }
  });
</script>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">
</script>
<meta http-equiv="X-UA-Compatible" CONTENT="IE=EmulateIE7" />


<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-84325623-1', 'auto');
    ga('send', 'pageview');
  }
</script>





</body>
</html>

